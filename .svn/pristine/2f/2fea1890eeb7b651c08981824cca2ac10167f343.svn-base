<?php
/**
 * 系统
 */
namespace common\server\Vip;

use common\base\BasicServer;
use common\model\db_customer\LossUser;
use common\model\db_customer\LossUserSub;
use common\server\CustomerPlatform\CommonServer;
use common\server\SysServer;

class LossUserServer extends BasicServer
{
    /**
     * 整合手机关联账号
     * @param $platform_id
     * @param int $limit
     * @return array
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public static function unionUserByCache($platform_id,$limit = 10)
    {
        $code = [
            0=>'success',1=>'平台id不存在',2=>'平台信息不存在',3=>'没有用户数据'
        ];

        if(!$platform_id){
            return ['code'=>1,'msg'=>$code[1]];
        }

        $platform_list = SysServer::getPlatformList();

        $platform_info = [];
        foreach ($platform_list as $item){
            if($item['platform_id'] == $platform_id){
                $platform_info = $item;
                break;
            }
        }

        if(empty($platform_info)){
            return ['code'=>2,'msg'=>$code[2]];
        }

        $memberModel = CommonServer::getPlatformModel('KefuCommonMember',$platform_info['suffix']);

        $cache_name_last_user_id = 'unionUserLastId'.'_'.$platform_id;

        $last_user_id = cache($cache_name_last_user_id);

        $where = [];
        if($last_user_id){
            $where['id'] = ['>',$last_user_id];
        }

        $where['mobile'] = ['<>',''];

        $field = '
            id
            ,uid
            ,user_name AS username
            ,mobile AS phone
            ,udid
            ,reg_date
        ';

        $user_list = $memberModel->field($field)->where($where)->order('id asc')->limit($limit)->select()->toArray();

        if(!$user_list){
            return ['code'=>3,'msg'=>$code[3]];
        }

        $lossUserModel = new LossUser();

        $lossUserSubModel = new LossUserSub();

        foreach ($user_list as $item){
            $last_user_id = $item['id'];
            if(!$item['udid']){
                continue;
            }

            if(preg_match('/^0{6}/',$item['udid'])){
                continue;
            }

            $this_loss_user_info = $lossUserModel->where([
                'platform_id'=>$platform_id,
                'udid'=>$item['udid'],
                'phone'=>$item['phone'],
            ])->find();

            if($this_loss_user_info){
                continue;
            }

            $lossUserModel->create([
                'platform_id'=>$platform_id,
                'udid'=>$item['udid'],
                'phone'=>$item['phone'],
                'reg_time'=>$item['reg_date'],
            ]);

            $where = [];
            $where['udid'] = $item['udid'];


            $this_user_list = $memberModel->field($field)->where($where)->select()->toArray();

            if(!$this_user_list){
                continue;
            }

            $this_loss_user_sub_add = [];

            $this_loss_user_sub_arr = $lossUserSubModel->where([
                'platform_id'=>$platform_id,
                'udid'=>$item['udid'],
            ])->column('uid');

            foreach ($this_user_list as $tul){
                if(in_array($tul['uid'],$this_loss_user_sub_arr)){
                    continue;
                }
                $this_loss_user_sub_add[] = [
                    'platform_id'=>$platform_id,
                    'uid'=>$tul['uid'],
                    'username'=>$tul['username'],
                    'udid'=>$tul['udid'],
                    'phone'=>$tul['phone']?$tul['phone']:$item['phone'],
                ];
            }

            if($this_loss_user_sub_add){
                $lossUserSubModel->saveAll($this_loss_user_sub_add);
            }
        }

         cache($cache_name_last_user_id,$last_user_id,3600);

        return ['code'=>0,'msg'=>$code[0],'data'=>['id'=>$last_user_id]];
    }

    /**
     * 获取已关联手机号
     * @param $platform_id
     * @param $param
     * @return mixed|object|array|bool|int|\stdClass|float|null
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public static function getPhone($platform_id,$param){

        $model = new LossUserSub();

        $where = getDataByField($param,['udid','username','uid'],true);

        if(empty($where)){
            return false;
        }
        $where['platform_id'] = $platform_id;

        $info = $model->where($where)->find();

        if(!$info){
            return false;
        }

        return $info->phone;
    }

    /**
     * 查询已关联账号信息
     * @param $platform_id
     * @param $param
     */
    public static function getUnionAccount($platform_id,$param){

        $model = new LossUserSub();

        $where = getDataByField($param,['udid','username','uid','phone'],true);

        if(empty($where)){
            return false;
        }
        $where['platform_id'] = $platform_id;

        $info = $model->where($where)->select()->toArray();

        return $info;
    }

    /**
     * 获取平台可关联所有账号信息
     * @param $platform_id
     * @param $param
     * @return false
     */
    public static function getAccount($platform_id,$param){

        $where = getDataByField($param,['udid','username','uid','phone'],true);

        if(!empty($where)){
            return false;
        }

        $platform_info = SysServer::getPlatformInfo($platform_id);

        if(!empty($platform_info)){
            return false;
        }

        $model = CommonServer::getPlatformModel('KefuCommonMember',$platform_info['suffix']);

        if(!empty($where['udid'])){
            return $model->where($where)->select()->toArray();
        }else{
            $info = $model->where($where)->find();

            if(!$info){
                return false;
            }

            return $model->where(['udid'=>$info['udid']])->select();
        }
    }


}
