<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<body>

<div style="padding: 12px;"  class="search_wrap" >
    <form class="layui-form" action="" id="search_form">

        <span id="common_search">
            
        </span>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">会话来源: </label>
            <div class="layui-input-inline">
                <div id="select_kf_source" class="xm-select-demo" style="min-width: 210px"></div>
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">评价: </label>
            <div class="layui-input-inline">
                <div id="select_kf_score" class="xm-select-demo" style="min-width: 210px"></div>
            </div>
        </div>

        <div class="layui-inline">
           <label class="layui-form-label">服务时间</label>

           <div class="layui-input-inline" style="width: 150px;">
               <input type="text" name="server_start" id="sdate" placeholder="开始时间" autocomplete="off" class="layui-input">
           </div>
           -
           <div class="layui-input-inline" style="width: 150px;">
               <input type="text" name="server_end" id="edate"  placeholder="结束时间" autocomplete="off" class="layui-input">
           </div>

       </div>

       <div class="layui-inline">
           <label class="layui-form-label">对话时长</label>

           <div class="layui-input-inline" style="width: 100px;">
               <input type="number" name="server_long_start" min="0"  placeholder="分钟" autocomplete="off" class="layui-input">
           </div>
           -
           <div class="layui-input-inline" style="width: 100px;">
               <input type="number" name="server_long_end" min="0" placeholder="分钟" autocomplete="off" class="layui-input">
           </div>

       </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">会话类型: </label>
            <div class="layui-input-inline">
                <select name="question_type" lay-search="" id="question_type">
                    <option value="">选择或搜索</option>
                </select>
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">咨询游戏: </label>
            <div class="layui-input-inline">
                <select name="game_type" lay-search="">
                    <option value="">选择或搜索</option>
                </select>
            </div>
        </div>
        <div class="layui-inline index_type index_type0" style="margin-bottom: 6px;">
            <label class="layui-form-label">分配状态: </label>
            <div class="layui-input-inline">
                <select name="set_admin_status" lay-search="">
                    <option value="0">全部</option>
                    <option value="1">未分配</option>
                    <option value="2">已分配</option>
                </select>
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">质检状态: </label>
            <div class="layui-input-inline">
                <select name="set_qc_status" lay-search="">
                    <option value="0">全部</option>
                    <option value="1">未质检</option>
                    <option value="2">已质检</option>
                </select>
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">质检员: </label>
            <div class="layui-input-inline">
                <select name="admin_id" lay-search="">
                    <option value="">选择或搜索</option>
                </select>
            </div>
        </div>

        <div class="layui-inline">
           <label class="layui-form-label">会话id: </label>
           <div class="layui-input-inline">
               <input type="text" name="text_id"  autocomplete="off" class="layui-input">
           </div>
       </div>

       <div class="layui-inline">
           <label class="layui-form-label">合作方ID: </label>
           <div class="layui-input-inline">
               <input type="text" name="partnerid"  autocomplete="off" class="layui-input">
           </div>
       </div>
       <div class="layui-inline">
           <label class="layui-form-label">内容搜索：</label>

           <div class="layui-input-inline">
               <input type="text" name="text" autocomplete="off" class="layui-input">
           </div>

       </div>
        

    </form>
</div>
<div class="layui-btn-group demoTable" style="padding: 0 15px;">
    <button class="layui-btn layui-btn-sm layui-power" id="Qc-list" data-type="search">搜索</button>
    <button class="layui-btn layui-btn-sm layui-power" id="Qc-addAdminIds" data-type="addAdminIds">分配质检</button>
    <button class="layui-btn layui-btn-sm layui-power" id="Qc-delAdminIds" data-type="delAdminIds">一键取消分配</button>
</div>


<div style="margin-top: 10px;display: none;" class="addAdminIds_div">
    <form class="layui-form" action="">
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">质检员: </label>
            <div class="layui-input-inline">
                <select name="add_admin_id" lay-search="">
                    <option value="">选择或搜索</option>
                </select>
            </div>
        </div>
    </form>
</div>


<div class="table_wrap" style="padding: 0 15px;">
    <table id="idTest" lay-filter="demo" class="layui-table"></table>
</div>


<script>
    var p_data = {};
    var lay_page = 1;
    var layui_obj = layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
        search: 'common/js/search',
    }).use(['common','jquery','table','laydate','form','xmSelect','search'], function(){
        var table   = layui.table,
            laydate = layui.laydate;
        var form = layui.form;
        var xmSelect = layui.xmSelect;
        var $ = layui.jquery;
        var common = layui.common;
        var search = layui.search;

        var page_type = common.urlParam.type;
        p_data.type = page_type;

        if(page_type == 1){
            common.initPowerShow(['Qc-delAdminIds','Qc-list']);//初始化权限显示
            // if(common.hasPower('Qc-delAdminIds')){
            //     $('.addAdminIds_div').show();
            // }
        }else{
            common.initPowerShow(['Qc-addAdminIds','Qc-list']);//初始化权限显示
            if(common.hasPower('Qc-addAdminIds')){
                $('.addAdminIds_div').show();
            }
        }

        initData();
        
        //日期
        laydate.render({
            elem: '#sdate',
            trigger : 'click',
            type: 'datetime'
        });
        laydate.render({
            elem: '#edate',
            trigger : 'click',
            type: 'datetime'
        });
        //监听工具条
        table.on('tool(demo)', function(obj){
            var data = obj.data;
            if(obj.event === 'logDetail'){
                var title='新建';
                var url = 'log_detail.html?qc_question_id='+data.id;
                // console.log(data);
                // return
                if(data.qc_question_log_id>0){
                    title = '编辑';
                    url = 'log_detail.html?id='+data.qc_question_log_id;
                }
                // console.log(title,url);return;
                let thisindex = layer.open({
                    type: 2,
                    title: title+'质检',
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['70%' , '70%'],
                    content: url
                });
                layer.full(thisindex);
            }else if(obj.event === 'delAdminIds'){
                layer.confirm('确认取消分配', function(index){
                    layer.close(index);
                    common.req({
                        url: "Qc/delAdminIds",
                        data: { id: [data.id] },
                        type: "post",
                        dataType:"json",
                        success:function(res){
                            if( res.code==0 ){
                                // layer.msg(res.msg,{icon:1});
                                // window.location.reload();
                                res_msg(res.msg);
                            }else{
                                layer.msg(res.msg,{icon:2});
                            }

                        },
                        error:function(res){
                            layer.alert('错误'+res.msg,{icon:2});
                        }
                    });

                });
            }else if(obj.event === 'detail'){
                var title='会话';
                var url = 'detail.html?id='+data.id;

                // console.log(title,url);return;
                let thisindex = layer.open({
                    type: 2,
                    title: title+'详情',
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['70%' , '70%'],
                    content: url
                });
                layer.full(thisindex);
            }else if(obj.event === 'setConversationNeedUpdate'){
                    common.req({
                        url: "Qc/setConversationNeedUpdate",
                        data: data,
                        type: "post",
                        dataType:"json",
                        success:function(res){
                            if( res.code==0 ){
                                layer.msg(res.msg,{icon:1});
                                // window.location.reload();
                                // res_msg(res.msg);
                            }else{
                                layer.msg(res.msg,{icon:2});
                            }

                        },
                        error:function(res){
                            layer.alert('错误'+res.msg,{icon:2});
                        }
                    });
            }
        });

        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            if( type=='search' ){
                //搜索
                let form_data = $('#search_form').serializeArray();
                // console.log(form_data);return false;
                $.each(form_data,function(k,v){
                    p_data[v.name] = v.value;
                })

                table.reload('idTest', {
                    method: 'post'
                    ,where: p_data
                    ,page: {
                        curr: 1
                    }
                });
            }else if( type=='addAdminIds' ){
                var ids = [];
                $.each($(".layui-table-fixed input[name=siam_one]:checked"), function (i, value) {
                    ids[i] = $(this).attr("data-id");  // 如果需要获取其他的值 需要在模板中把值放到属性中 然后这里就可以拿到了
                });
                var admin_id = $('select[name="add_admin_id"]').val();
                if(admin_id == ''){
                    layer.msg('请选择质检员');
                    return; 
                }
                if(ids.length == 0){
                    layer.msg('请选择会话');
                    return; 
                }
                
                common.req({
                    url: "Qc/addAdminIds",
                    data: { ids: ids ,admin_id:admin_id},
                    type: "post",
                    dataType:"json",
                    success:function(res){
                        if( res.code==0 ){
                            // window.location.reload();
                            // layer.msg(res.msg,{icon:1});
                            res_msg(res.msg);
                        }else{
                            layer.msg(res.msg,{icon:2});
                        }
                    },
                    error:function(data){
                        layer.alert('错误'+data.msg,{icon:2});
                    }
                });
            }else if( type=='delAdminIds' ){
                var ids = [];
                $.each($(".layui-table-fixed input[name=siam_one]:checked"), function (i, value) {
                    ids[i] = $(this).attr("data-id");  // 如果需要获取其他的值 需要在模板中把值放到属性中 然后这里就可以拿到了
                });

                if(ids.length == 0){
                    layer.msg('请选择会话');
                    return; 
                }
                
                common.req({
                    url: "Qc/delAdminIds",
                    data: { id: ids },
                    type: "post",
                    dataType:"json",
                    success:function(res){
                        if( res.code==0 ){
                            // window.location.reload();
                            // layer.msg(res.msg,{icon:1});
                            res_msg(res.msg);
                        }else{
                            layer.msg(res.msg,{icon:2});
                        }
                    },
                    error:function(data){
                        layer.alert('错误'+data.msg,{icon:2});
                    }
                });
            }
        });

        form.on("checkbox(siam_all)", function () {
            var status = $(this).prop("checked");
            $.each($("input[name=siam_one]"), function (i, value) {
                $(this).prop("checked", status);
            });
            form.render();
        });

        function initData(){

            var search_config_def = {
                'platform':{
                    'status':1
                    ,'name':'kf_platform'
                }
                ,'admin':{
                    'status':1
                    ,'p_data':{group_type:[1,4,5]}
                    ,'title':'客服'
                    ,'name':'kf_id'
                }
            };

            search.init('common_search',search_config_def);

            common.req({
                url: 'Qc/config' //获取游戏名称
                ,success:function(json)
                {
                    var kf_source_data = [];
                    var kf_score_data = [];
                    var qc_admin_list_data = [];
                    var base_config = json.data;

                    $.each(base_config.kf_source_arr,function(k,v){
                        var this_data = {};
                        this_data.name = v;
                        this_data.value = k;
                        kf_source_data.push(this_data);
                    });
                    $.each(base_config.kf_score_arr,function(k,v){
                        var this_data = {};
                        this_data.name = v;
                        this_data.value = k;
                        kf_score_data.push(this_data);
                    });
                    $.each(base_config.qc_admin_list,function(k,v){
                        $('select[name=add_admin_id]').append('<option value="'+v.id+'">'+v.name+'</option>');
                        $('select[name=admin_id]').append('<option value="'+v.id+'">'+v.name+'</option>');
                    });
                    $.each(base_config.game_type,function(k,v){
                        $('select[name=game_type]').append('<option value="'+k+'">'+v+'</option>');
                    });

                    



                    var select_kf_source = xmSelect.render({
                        el: '#select_kf_source',
                        // prop:{
                        //     name:'reason',
                        //     value:'reason',
                        // },
                        toolbar: {
                            show: true,
                            list: [ 'ALL', 'CLEAR', 'REVERSE' ]
                        },
                        data: kf_source_data,
                        name:'kf_source',
                        on: function(data){
                            //arr:  当前多选已选中的数据
                            var arr = data.arr;
                            //change, 此次选择变化的数据,数组
                            var change = data.change;
                            //isAdd, 此次操作是新增还是删除
                            var isAdd = data.isAdd;

                            if(arr.length!=0){
                                set_source_info(arr[0].value);
                            }

                            //可以return一个数组, 代表想选中的数据
                            //return []
                        },
                    })
                    var select_kf_score = xmSelect.render({
                        el: '#select_kf_score',
                        // prop:{
                        //     name:'reason',
                        //     value:'reason',
                        // },
                        toolbar: {
                            show: true,
                            list: [ 'ALL', 'CLEAR', 'REVERSE' ]
                        },
                        data: kf_score_data,
                        name:'kf_score',
                        on: function(data){
                            //arr:  当前多选已选中的数据
                            var arr = data.arr;
                            //change, 此次选择变化的数据,数组
                            var change = data.change;
                            //isAdd, 此次操作是新增还是删除
                            var isAdd = data.isAdd;

                            // if(arr.length!=0){
                            //     set_source_info(arr[0].value);
                            // }

                            //可以return一个数组, 代表想选中的数据
                            //return []
                        },
                    })

                    form.render();
                }
            });

            

            table.render({
                elem: '#idTest'
                ,height: 'full-120'
                ,url: common.getUrl('Qc/list') //数据接口
                ,page: true //开启分页
                ,limits:[20,50,100,200,500]
                ,limit:20
                ,method:'post'
                ,where:p_data
                ,minWidth:1000
                ,autoWidth:true
                ,headers:common.getHeader()
                ,cols: [[ //表头
                    {
                         title:"<input type='checkbox' name='siam_all' title='' lay-skin='primary' lay-filter='siam_all'>"
                        // , minWidth:50
                        , width:50
                        , fixed: 'left'
                        ,templet:function(d){
                            if(page_type == 1){
                                if(d.admin_id > 0){
                                    return '<input type="checkbox" name="siam_one" title="" lay-skin="primary" data-id = "'+d.id+'">';
                                }else{
                                    return '';
                                }
                            }else{
                                if(d.admin_id == '0'){
                                    return '<input type="checkbox" name="siam_one" title="" lay-skin="primary" data-id = "'+d.id+'">';
                                }else{
                                    return '';
                                }
                            }
                            
                        }
                    }
                    ,{field:'text_id',minWidth:100, sort: true, title:'会话ID'}
                    ,{field:'kf_name', width:100, title:'客服'}
                    ,{field:'admin_id_str', width:100, title:'质检员'}
                    ,{field:'kf_source_str', minWidth:100, title:'来源'}
                    ,{field:'kf_score_str', minWidth:90, title:'评价类型'}
                    ,{field:'server_start_str', minWidth:150, title:'对话开始时间'}
                    ,{field:'server_end_str', minWidth:150, title:'对话结束时间'}
                    ,{field:'server_long', minWidth:125, title:'对话时长(min)'}
                    ,{field:'question_type', minWidth:100, title:'会话类型'}
                    ,{field:'is_qc', minWidth:100, title:'质检状态'}
                    ,{minWidth:273, align:'center', fixed: 'right', title:'操作'
                    ,templet:function(d){
                            let str = '';
                            if(d.action){
                                $.each(d.action,function(k,v){
                                    str+= action(v,d);
                                })
                            }
                            return str;
                        }
                    }
                ]]
                ,done:function(a,b,c){
                    lay_page = b;
                    if(c > 0){

                    }
                }
            });
        }


        function set_source_info(kf_source){
            common.req({
                url: "Qc/getSourceConfig",
                data: {'kf_source':kf_source,keys:'question_type'},
                type: "post",
                dataType:"json",
                success:function(res){
                    if( res.code==0 ){

                        $.each(res.data, function (k, v) {
                            if(k === 'qc_score_dec' || k === 'qc_score_inc'){
                                let class_name = '.select_'+k;
                                $(class_name).html('<option value="" data-score="0">请选择</option>');
                                $.each(v,function (k1,v1){
                                    $.each($(class_name),function (k,v){
                                        let thisdataval = $(v).attr('data-val');
                                        if(v1.reason === thisdataval){
                                            // $(v).append(new Option(v1.reason,v1.score,true,true));
                                            $(v).append('<option value="'+v1.reason+'" data-score="'+v1.score+'" selected>'+v1.reason+'</option>');
                                            var this_score_input_obj = $(v).parent().parent().parent().find('.score_num').find('input');
                                            this_score_input_obj.val(this_score_input_obj.attr('def-value'));
                                        }else{
                                            $(v).append('<option value="'+v1.reason+'" data-score="'+v1.score+'">'+v1.reason+'</option>');
                                        }

                                    })
                                })
                            }else{
                                let this_id_obj = $('#'+k);
                                this_id_obj.html('<option value="">请选择</option>');
                                $.each(v,function (k1,v1){
                                    let thisdataval = this_id_obj.attr('data-val');
                                    if(v1 === thisdataval){
                                        this_id_obj.append('<option value="'+v1+'"  selected>'+v1+'</option>');
                                    }else{
                                        this_id_obj.append('<option value="'+v1+'" >'+v1+'</option>');
                                    }
                                })
                            }
                            
                        });
                        layui.form.render("select");//重新渲染 固定写法
                    }
                },
                error:function(data){
                    layer.alert('错误'+data.msg,{icon:2});
                }
            });
        }

        
    });
    //给子级调用
    function res_msg(msg){
        layer.msg(msg,{icon:1});
        setTimeout(function(){
            // window.location.reload();
            layui_obj.table.reload('idTest', {
                method: 'post'
                ,where: p_data
                ,page: {
                    curr: lay_page
                }
            });
        },1000);
    }

    function action(action,data){
        let str = '';
        switch (action) {

            case 'logDetail':
                str = '<a class="layui-btn layui-btn-xs" lay-event="logDetail">质检</a>';
                break;
            case 'delAdminIds':
                str = '<a class="layui-btn layui-btn-xs" lay-event="delAdminIds">取消分配</a>';
                break;
            case 'detail':
                str = '<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>';
                break;
            case 'setConversationNeedUpdate':
                str = '<a class="layui-btn layui-btn-xs" lay-event="setConversationNeedUpdate">设置会话更新</a>';
                break;
            default:

                break;
        }

        return str;
    }
</script>
</body>
</html>