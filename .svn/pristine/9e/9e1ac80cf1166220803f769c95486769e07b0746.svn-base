<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
    <form class="layui-form" lay-filter="form-info" action="" style="padding: 20px;">
        <div class="layui-form-item">
            <label class="layui-form-label">菜单类型</label>
            <div class="layui-input-inline">
                <select name="menu_type" lay-filter="menu_type" id="menu_type">
                </select>
            </div>
        </div>
        <div class="layui-form-item p_menu menu_lev1" style="display:none;">
            <label class="layui-form-label">一级菜单</label>
            <div class="layui-input-inline">
                <select name="menu_lev1"  lay-filter="menu_lev1" id="menu_lev1" lay-search="">
                    <option value="">选择或搜索</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item p_menu menu_lev2" style="display:none;">
            <label class="layui-form-label">二级级菜单</label>
            <div class="layui-input-inline">
                <select name="menu_lev2"  lay-filter="menu_lev2" id="menu_lev2" lay-search="">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">菜单名称</label>
            <div class="layui-input-inline">
                <input type="text" name="menu_name" lay-verify="required" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">控制器</label>
            <div class="layui-input-inline">
                <input type="text" name="controller" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">操作方法</label>
            <div class="layui-input-inline">
                <input type="text" name="action" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item url_wrap" style="display:block;">
            <label class="layui-form-label">链接:</label>
            <div class="layui-input-inline">
                <input type="text" name="url"  autocomplete="off" class="layui-input">
                <span style="display: inline-block; margin-top: 6px; color: red; font-size: 13px;">配置了链接后，优先使用链接</span>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">类型</label>
            <div class="layui-input-inline">
                <select name="type" lay-filter="type" id="type">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">排序</label>
            <div class="layui-input-inline">
                <input type="number" name="sort"  autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">是否展示</label>
            <div class="layui-input-block">
                <!-- <input type="checkbox" checked="" name="is_show" lay-skin="switch" lay-text="ON|OFF"><div class="layui-unselect layui-form-switch layui-form-onswitch" lay-skin="_switch"><em>ON</em><i></i></div> -->

                <input type="checkbox" name="is_show" lay-skin="switch">
            </div>
        </div>
        <input type="hidden" name="menu_id" value="0">
        <div class="layui-form-item">
            <div class="layui-input-block">
              <button type="submit" class="layui-btn" lay-submit="" lay-filter="submit_btn">立即提交</button>
            </div>
        </div>
    </form>
        <!-- 加载动画 -->
    <div class="page-loading">
        <div class="ball-loader">
            <span></span><span></span><span></span><span></span>
        </div>
    </div>
</body>

<script>
    var p_data = {};
    var layui_obj = layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
    }).use(['common','jquery','form'], function(){
        var $ = layui.jquery;
        var common = layui.common;
        var form = layui.form
        ,layer = layui.layer;
        var id = 0;
        var detail_info = {};
        var urlParam = common.urlParam;

        //初始化数据
        initData();
        //隐藏加载框
        common.isLoading(false);

        //菜单类型选择改变事件
        form.on('select(menu_type)', function(data){
            changeMenuType(data.value);
        });

        //类型选择改变事件
        form.on('select(type)', function(data){
            changeType(data.value);
        });

        //一级菜单选择事件
        form.on('select(menu_lev1)', function(data){

            var f_menu_val = data.value,
                menu_type  = $("#menu_type").val();
                detail_info.menu_lev1 = f_menu_val;

            if( menu_type==3 ){
                getMenuList($('#menu_lev2'),{'p_id':f_menu_val});
            }
        });


        //监听提交
        form.on('submit(submit_btn)', function(data){
            var url = "Sysmanage/menuAdd";
            if(id>0){
                url = "Sysmanage/menuEdit";
                if(!common.hasPower('Sysmanage-menuEdit','没有修改权限')){
                    return false;
                }
            }else{
                if(!common.hasPower('Sysmanage-menuAdd','没有添加权限')){
                    return false;
                }
            }
            common.req({
                url: url,
                data: data.field,
                success:function(json){
                    console.log(json);
                    if( json.code==0 ){
                        var index = parent.layer.getFrameIndex(window.name);
                        window.parent.res_msg(json.msg);
                        parent.layer.close(index);//关闭当前页
                        //window.parent.location.reload(); //刷新父窗口
                    }else{
                        layer.alert(json.msg);
                    }
                }
            });
            return false;
        });

        function initData(){
            
            if(urlParam.id>0){
                id = urlParam.id;
            }

            p_data = urlParam;

            common.req({
                url:'Sysmanage/menuDetail'
                ,data:p_data
                ,success:(json)=>{
                    if(json.code == 0){
                        
                        detail_info = json.data;
                        config = json.config;
                        if(detail_info.is_show != 1){
                            detail_info.is_show = 0;
                        }
                        common.setOption1(config.type_arr,$('#type'));
                        common.setOption1(config.menu_type_arr,$('#menu_type'));
                        changeType(detail_info.type);

                        var p = changeMenuType(detail_info.menu_type);

                        p.then(()=>{
                            form.val('form-info', json.data);
                            form.render();
                        })
                        
                    }else{
                        layer.alert('错误'+json.msg);
                    }
                }
            })
        }


        //菜单等级改变逻辑
        function changeMenuType(val){
            $(".p_menu").hide();
            // $(".url_wrap").hide();
            var p = new Promise(function(resolve, reject){
                resolve(3);
            });
            if( val==2 ){
                $(".menu_lev1").show();
                // $(".url_wrap").show();
                p = getMenuList($('#menu_lev1'));
            }else if( val==3 ){
                $(".p_menu").show();
                p = getMenuList($('#menu_lev1'));
                if(detail_info.menu_lev1>0){
                    p = p.then((data)=>{
                        return getMenuList($('#menu_lev2'),{'p_id':detail_info.menu_lev1});
                    })
                }
            }
            return p;
        }
        function changeType(val){
            $(".url_wrap").show();
            if( val==2 ){
                $(".url_wrap").hide();
            }
            return true;
        }

        
        //获取子菜单列表
        function getMenuList(obj,p_data){
            var str = '<option value="">选择或搜索</option>';
            var p = new Promise(function(resolve, reject){
                common.req({
                    url:'Ajax/getMenuList'
                    ,data:p_data
                    ,async:false
                    ,success:(json)=>{
                        if(json.code == 0){
                            $.each(json.data,(k,v)=>{
                                str+='<option value="'+v['id']+'">'+v['menu_name']+'</option>';
                            })
                        }
                        obj.html(str);
                        form.render("select");
                        resolve(1)
                    }
                })
            });
            
            return p;
        }
    });
</script>
</html>