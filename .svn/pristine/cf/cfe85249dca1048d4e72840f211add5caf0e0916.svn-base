<?php
namespace app\api\controller;


use common\libraries\Common;
use common\libraries\ElasticSearch;
use common\model\db_statistic\EveryDayOrderCount;

class Test extends Base
{
   public function index()
   {
       $es = new ElasticSearch();
       $time = time();
       $dateStart = $time-60;
       $dateEnd = $time;

       $range0['range']['time']['gte']  = $dateStart;

       $range0['range']['time']['lte']  = $dateEnd;

       if($range0){
           $bool['bool']['filter']['bool']['must'][] = $range0;
       }
       $last_month = Common::GetMonth(1);
       $now_month = date('Ym');
       $next_month = Common::GetMonth(0);
       $result = $es->search(
           [
               $es->index_name.'-'.$last_month,
               $es->index_name.'-'.$now_month,
               $es->index_name.'-'.$next_month
           ],
           $bool,
           '',
           ['time'=>['order'=>'desc']],
           1,
           1
       );

       echo json_encode($result);
   }

    public function updateEveryMount(){

       set_time_limit(0);
        $flag = true;
        $i = 0;
        $limit = 100;
        $model = new EveryDayOrderCount();
        $start_flag = 0;
        while($flag){
            $offset = $i*$limit;

            $sql = "	SELECT
					id
				FROM
					every_day_order_count
					where id>{$start_flag}
					and partition_key is null
				ORDER BY
					id
				LIMIT 0,
				{$limit}";

            $ids = $model->query($sql);

            $start_flag = $ids[count($ids)-1]['id'];


            if(empty($ids)){
                dd('ok');
            }
            $ids = array_column($ids,'id');
            $ids_str = implode(',',$ids);


            $sql = "update every_day_order_count set partition_key = FROM_UNIXTIME(UNIX_TIMESTAMP(`date`),'%Y%m')  where id in({$ids_str})";

            $model->execute($sql);
            $i++;
        }

    }
}
