<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<body>
<style>
    .layui-form-item .layui-form-checkbox { margin: 0; }
    #reload_time_wrap input.layui-input { height: 30px; }
</style>
<div style="padding: 12px;"  class="search_wrap">
    <form class="layui-form" action="" id="search_form">

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">平台: </label>
            <div class="layui-input-inline">
                <select name="tkey" lay-filter="tkey" id="tkey" lay-search="">
                    <option value="">选择或搜索</option>

                </select>
            </div>
        </div>


        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">游戏: </label>
            <div class="layui-input-inline">
                <select name="game"  lay-filter="game" id="game" lay-search="">
                    <option value="">选择或搜索</option>

                </select>
            </div>
        </div>

<!--        <div class="layui-inline" style="margin-bottom: 6px;">-->
<!--            <label class="layui-form-label">内容: </label>-->
<!--            <div class="layui-input-inline">-->
<!--                <input type="text" name="content" id="content" autocomplete="off" class="layui-input" >-->
<!--            </div>-->
<!--        </div>-->
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">用户ID: </label>
            <div class="layui-input-inline">
                <input type="text" name="uid" id="uid" autocomplete="off" class="layui-input" >
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">角色名称: </label>
            <div class="layui-input-inline">
                <input type="text" name="uname" id="uname" autocomplete="off" class="layui-input" >
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">区服或ID: </label>
            <div class="layui-input-inline">
                <input type="text" name="sid" id="sid" autocomplete="off" class="layui-input" >
            </div>
        </div>


        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">账号累充: </label>
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" name="money_min" id="money_min" autocomplete="off" class="layui-input" >
            </div>-
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" name="money_max" id="money_max" autocomplete="off" class="layui-input" >
            </div>
        </div>


        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">时间: </label>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="sdate" id="sdate" lay-verify="sdate" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="1" value="{{ date('Y-m-d 00:00:00') }}">
            </div>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="edate" id="edate" lay-verify="edate" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="2" value="{{ date('Y-m-d 23:59:59') }}">
            </div>
        </div>



        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">等级范围: </label>
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" name="level_min" id="level_min" autocomplete="off" class="layui-input" >
            </div>-
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" name="level_max" id="level_max" autocomplete="off" class="layui-input" >
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">状态: </label>
            <div class="layui-input-inline">
                <select name="status" lay-filter="status" id="status" lay-search="">
                    <option value="-1">选择或搜索</option>
                    <option value="0">未审核</option>
                    <option value="1">已封禁</option>
                    <option value="2">已删除</option>

                </select>
            </div>
        </div>


    </form>
</div>
<div class="layui-btn-group demoTable" style="padding: 0 15px;">
    <button class="layui-btn layui-btn-sm" data-type="search" id="search_btn">搜索</button>
    <button type="button" id="refresh" class="layui-btn  layui-btn-sm">
        <i class="layui-icon layui-icon-refresh"></i>
    </button>
    <button class="layui-btn layui-btn-sm" data-type="blockUser">批量封用户</button>

<!--    <button class="layui-btn layui-btn-sm" data-type="blockChat">批量禁言</button>-->

    <button class="layui-btn layui-btn-sm" data-type="del">批量删除</button>
</div>
<div class="table_wrap" style="padding: 0 15px;">
    <table class="layui-table"  lay-filter="demo" id="demo">
    </table>
</div>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="block">封号</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="chat">禁言</a>
</script>

<script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>

<script>
    var timer = null;
    var times1 = 5000;

    var open_arr = [];
    var where = {};

    layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
        search: 'common/js/search',
    }).use(['table','laydate','form','jquery','common','search'], function(){
        var table   = layui.table,
            laydate = layui.laydate,
            $ = layui.jquery,
            search = layui.search,
            common = layui.common,
            form    = layui.form;

        //日期
        laydate.render({
            elem: '#sdate',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date().toLocaleDateString()),

        });


        laydate.render({
            elem: '#edate',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(Date.parse(new Date().toLocaleDateString())+86400000),

        });


        common.req({
            url:'ajax/getGameProduct'
            ,success:function(json)
            {
                if(json.code == 0){
                    let html = '';
                    $.each(json.data,function(k,v){

                        html ='<option value="'+v.code+'">'+v.name+'</option>';
                        $('#game').append(html)
                    })

                    form.render('select');


                }else {
                    layer.msg(json.msg,{icon:2});
                }
            }
        })

        common.req({
            url:'ajax/getPlatformList'
            ,success:function(json)
            {
                if(json.code == 0){
                    let html = '';
                    $.each(json.data,function(k,v){

                        html ='<option value="'+v.suffix+'">'+v.name+'</option>';
                        $('#tkey').append(html)
                    })

                    form.render('select');


                }else {
                    layer.msg(json.msg,{icon:2});
                }
            }
        })



        // common.req({
        //     url:'elastic_search_chat/getTypes'
        //     ,success:function(json)
        //     {
        //         if(json.code == 0){
        //             let html = '';
        //             $.each(json.data,function(k,v){
        //
        //                 html ='<option value="'+k+'">'+v+'</option>';
        //                 $('#type').append(html)
        //             })
        //
        //             form.render('select');
        //
        //
        //         }else {
        //             layer.msg(json.msg,{icon:2});
        //         }
        //     }
        // })


        //第一个实例
        table.render({
            elem: '#demo',
            headers:common.getHeader()
            ,height: 'full-150'
            ,url: common.getUrl('role_name_block_waring/index') //数据接口
            ,page: true //开启分页
            ,limit: 20
            ,limits:[20,50,100,200,500]
            ,cols: [[ //表头
                {type:'checkbox',  width:40, fixed: 'left'}
                ,{field: 'id', title: 'ID', minWidth:100}
                ,{field: 'time', title: '日期', minWidth:180}
                ,{field: 'role_name', title: '角色名', minWidth:150}
                ,{field: 'uid', title: '用户ID', minWidth:100}
                ,{field: 'platform_key', title: '平台', minWidth:100}
                ,{field: 'count_money', title: '充值金额', minWidth:100}
                ,{field: 'server_id', title: '区服', minWidth:100}
                ,{field: 'platform_gkey', title: '游戏', minWidth:150}
                ,{field: 'role_level', title: '角色等级', minWidth:100}
                ,{field: 'status', title: '状态', minWidth:100}
                ,{title: '操作',minWidth:160, align:'center',  fixed: 'right',
                    templet: function(d) {

                        if (d.status == '已封禁') {

                            var div = '<a>已处理</a>'

                        }else if(d.status == '已删除'){
                            var div = '<a>已删除</a>'
                        }else{
                            var div = ' <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="block">封号</a>';
                            div += ' <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>';
                             // div += '<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="chat">禁言</a>';
                        }
                        return div
                    }}
            ]]
            ,parseData:function(res){
                if(res.code != 0){

                    layer.msg(res.msg,{icon:2});
                    res.msg = '获取失败';
                }

                return {
                    'code' : res.code,
                    'msg' : res.msg,
                    'data' : res.data,
                    'count' : res.count,
                }
            }
        });



        //自动刷新
        form.on('checkbox',function(data){
            if( 'auto_rfresh' == $(data.elem).attr('id') ){
                if( $(data.elem).prop('checked') ){
                    auto_rfresh();
                }else{
                    clearTimeout(timer);
                }
            }
        });

        function auto_rfresh(){
            clearTimeout(timer);
            $("#search_btn").click();
            times1 = $("#reload_time").val()*1000;
            timer = setTimeout(function(){
                console.log(1);
                auto_rfresh();
            },times1);
        }

        //监听工具条
        table.on('tool(demo)', function(obj){
            var data = obj.data;

            if(obj.event === 'block'){
                if(data.status == 1){
                   layer.alert('账号已封');
                   return;
                }

                if(data.platform_key == '渠道平台'){
                    layer.alert('渠道平台请去cp后台处理');
                    return;
                }

                layer.open({

                    title:'时长选择',

                    content:"<input type=\"text\" name=\"block_time\" id=\"block_time\" autocomplete=\"off\" class=\"layui-input\" placeholder=\"小时\" >",
                    yes:function(index,layero){
                        var block_time = $('#block_time').val();

                        var ids = [];
                        var es_ids = [];
                        var uids = [];

                        ids.push(data['id']);
                        es_ids.push(data['id']);
                        uids.push(data['uid']);
                        var type = 'blockUser';
                        var block_txt = "确定封禁选中用户吗？"
                        layer.confirm( block_txt, function(index){
                            layer.close(index);

                            var url ="role_name_block/"+type;


                            block_fun(url,es_ids,block_time,uids,ids);
                        });
                    }
                });

            }else if(obj.event === 'del'){
                var ids = [];
                ids.push(data['id']);
                layer.confirm( "确定删除选中信息吗？", function(index){
                    common.req({
                        url: 'role_name_block_waring/del',
                        data: { a_ids: ids },
                        type: "post",
                        dataType:"json",
                        success:function(res){

                            if( res.code ){
                                layer.alert('操作成功');
                                table.reload('demo');
                            }else{
                                layer.alert('操作失败');
                            }
                        },
                    });
                });
            }



        });

        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            if( type=='search' ){
                //搜索
                let where = {};
                let form_data = $('#search_form').serializeArray();
                $.each(form_data,function(k,v){
                    where[v.name] = v.value;
                })

                table.reload('demo', {
                    method: 'post'
                    ,where: where
                    ,page: {
                        curr: 1
                    },
                });
            }else if(  type.indexOf('block') != -1   ){
                //批量封用户
                var checkStatus = table.checkStatus('demo')
                    ,data = checkStatus.data;

                if( data.length<=0 ){
                    layer.msg("未选择任何行！",{icon:2});
                    return;
                }

                var block_txt = '';
                if( type=='blockUser' ) block_txt = "确定封禁选中用户吗？";
                if( type=='blockIp' )   block_txt = "确定封禁选中IP吗？";
                if( type=='blockImei' ) block_txt = "确定封禁选中IMEI吗？";
                if( type=='blockChat' ) block_txt = "确定禁言选中角色吗？";

                layer.confirm( block_txt, function(index){
                    layer.close(index);
                    var es_ids = [];
                    var uids = [];
                    var ids = [];
                    for( var i=0; i<data.length; i++ ){

                        if(data[i]['platform_key'] == '渠道平台'){
                            layer.alert('渠道平台请去cp后台处理');
                            return;
                        }


                        es_ids.push(data[i]['id']);
                        ids.push(data[i]['id']);
                        uids.push(data[i]['uid']);
                    }

                    var url     = "/role_name_block/"+type;
                    block_fun(url,es_ids,0,uids,ids);
                });

            }else if(type=='del'){

                var checkStatus = table.checkStatus('demo'),data = checkStatus.data;

                if( data.length<=0 ){
                    layer.msg("未选择任何行！",{icon:2});
                    return;
                }
                var ids = [];
                for( var i=0; i<data.length; i++ ){

                    if(data[i]['platform_key'] == '渠道平台'){
                        layer.alert('渠道平台请去cp后台处理');
                        return;
                    }

                    ids.push(data[i]['id']);
                }

                layer.confirm( "确定删除选中信息吗？", function(index){
                    common.req({
                        url: 'role_name_block_waring/del',
                        data: { a_ids: ids },
                        type: "post",
                        dataType:"json",
                        success:function(res){

                            if( res.code ){
                                layer.alert('操作成功');
                                table.reload('demo');
                            }else{
                                layer.alert('操作失败');
                            }
                        },
                    });
                });




            }
        });

        //封禁操作
        function block_fun(url,ids,block_time,uids,es_ids){

            if(block_time != ''){
                block_time = block_time*3600;
            }
            common.req({
                url: url,
                data: { a_ids: ids ,block_time:block_time,uids:uids},
                type: "post",
                dataType:"json",
                success:function(res){

                    if( res.code ){
                        var msg = "封禁成功："+res.succ+"<br/>"+"封禁失败："+res.fail+"<br/>"+"重复封禁："+res.isBlocked;
                        updateBlockWaring(es_ids);
                        layer.alert(msg);
                        table.reload('demo');
                    }else{
                        layer.alert(res.msg);
                    }
                },
            });
        }


        function updateBlockWaring(ids)
        {
            common.req({
                url: "block_waring/update",
                data: { a_ids: ids },
                type: "post",
                dataType:"json",
                success:function(res){

                    if( res.status ){

                    }else{
                        // layer.alert(res.msg);
                    }
                },
            });
        }

        //区服范围添加
        $('#sid_add').on('click', function(){
            var sid_min = $('#sid_min').val();
            var sid_max = $('#sid_max').val();


            var flag = false;
            var idx = '';
            var idx1 = '';
            var reg = new RegExp("^[a-zA-Z]");
            if(reg.test(sid_min.substr(0, 1))){
                idx = sid_min.substr(0, 1);
                console.log(idx);
                sid_min = sid_min.substr(1, 10)
                flag = true;
            }

            if(reg.test(sid_max.substr(0, 1))){
                idx1 = sid_max.substr(0, 1);
                console.log(idx1);
                sid_max = sid_max.substr(1, 10)
                flag = true;
            }

            if(idx != idx1){
                layer.alert('特殊区服开始与结束的标记必须一致');
                return false;
            }
            var sidval = '';

            if(flag){

                for(var i=sid_min*1;i<=sid_max*1;i++){

                    if(sidval==''){

                        sidval += idx + i;
                    }else{
                        sidval +=','+idx + i;
                    }
                    // alert(sidval)
                }

            }else{
                for(var i=sid_min*1;i<=sid_max*1;i++){
                    if(sidval==''){

                        sidval +=i;
                    }else{
                        sidval +=','+i;
                    }
                }
            }

            $('#sid').val(sidval);
        });

        $(document).keyup(function(e){
            var key =  e.which || e.keyCode;;
            if(key == 27){
                var check_chat_index = open_arr.pop();
                layer.close(check_chat_index)
            }
        });
    });
    //给子级调用
    function res_msg(msg){
        layer.msg(msg,{icon:1});
        setTimeout(function(){
            window.location.reload();
        },1000);
    }




</script>
</body>
</html>