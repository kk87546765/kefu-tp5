<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
</head>
<style type="text/css">
    .children-div{
        padding-left: 30px;
    }
</style>
<body class="hold-transition skin-blue sidebar-mini">

    
    <!-- Main content -->
    <div style="padding: 12px 15px;" class="layui-btn-group demoTable">

        <button type="button" id="refresh" class="layui-btn layui-btn-sm" ew-event="refresh1">
            <i class="layui-icon layui-icon-refresh"></i>
        </button>

        <button type="button" id="submit" class="layui-btn layui-btn-sm">提交</button>
        
        <!-- <span style="display: inline-block; font-size: 14px; line-height: 30px; margin-left: 12px; vertical-align: middle; color: red;">点击名称可编辑！</span> -->
    </div>

    <!-- <div id="menu_list" class="demo-tree demo-tree-box" style="padding: 20px; margin: 0 15px; border: 1px solid #aaa;"></div> -->
    <div id="menu_list" class="layui-form" lay-filter="edit-form" style="padding: 20px; margin: 0 15px; border: 1px solid #aaa;"></div>

    <script>

    
    var click_name = 'sysmanage_role_click_id';
    var menu_id = 0;

    var layui_obj = layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
    }).use(['common','jquery','tree','form'], function(){
        var tree = layui.tree;
        var form = layui.form;
        var $ = layui.jquery;
        var common = layui.common;
        menu_id = common.urlParam.menu_id;

        setList().then((data)=>{
            setListValue();
        });

        $('#submit').click(()=>{

            var p_data = form.val('edit-form')
            p_data.menu_id = menu_id;
            
            common.req({
                url: "sysmanage/menuPowerRoleSave",
                data: p_data,
                type: "post",
                dataType:"json",
                success:function(res){
                    
                    if( res.code==0 ){
                        setListValue();
                        layer.msg(res.msg,{icon:1});
                    }else{
                        layer.msg(res.msg,{icon:2});
                    }
                },
                error:function(res){
                    layer.alert('错误'+res.msg,{icon:2});
                }
            });
        })

        function setList(){
            var click_id = common.getTempData(click_name);
            return new Promise((resolve, reject)=>{
                common.req({
                    url: "sysmanage/roleList",
                    data: {'click_id':click_id},
                    type: "post",
                    dataType:"json",
                    success:function(res){
                        if( res.code==0 ){
                            $('#menu_list').html(getCheckStr(res.data,0));
                            form.render();
                            resolve(1)
                        }else{
                            resolve(0)
                            layer.msg(res.msg,{icon:2});
                        }
                    },
                    error:function(res){
                        reject(0)
                        layer.alert('错误'+res.msg,{icon:2});
                    }
                });
            }).catch((e) => {});
        }

        function setListValue(){

            common.req({
                url: "sysmanage/menuPowerRole",
                data: {'menu_id':menu_id},
                type: "post",
                dataType:"json",
                success:function(res){
                    if( res.code==0 ){

                        var this_form_data = {};
                        $.each(res.data,(k,v)=>{
                            this_form_data['role_ids['+v+']'] = v;
                        })
                        form.val('edit-form',this_form_data)
                        form.render();
                    }
                },
                error:function(res){
                    layer.alert('错误'+res.msg,{icon:2});
                }
            });
        }


        function getCheckStr(menus,child_index){
            var str = '<div class="children-div children-div-'+child_index+'">';
            child_index++;
            $.each(menus, function (index, item) {

                str+= '<input type="checkbox" name="role_ids['+item.role_id+']" lay-skin="primary" value="'+item.role_id+'" title="'+item.role_name+'">';

                var i = getCheckStr(item.children,child_index);
                str+=i;
            });
            str +='</div>';
            return str;
        }
        function change(id,type){
            var this_arr = common.getTempData(click_name);

            if(typeof this_arr != 'object'){
                this_arr = [];
            }
            this_arr.remove(id);

            if(type=='open'){
                this_arr.push(id);
            }

            common.putTempData(click_name,this_arr);
        }


        function getCheckedId(jsonObj) {
            var id = "";
            $.each(jsonObj, function (index, item) {
                if (id != "") {
                    id = id + "," + item.id;
                }
                else {
                    id = item.id;
                }
                var i = getCheckedId(item.children);
                if (i != "") {
                    id = id + "," + i;
                }
            });
            return id;
        }
    });

</script>
</body>
</html>