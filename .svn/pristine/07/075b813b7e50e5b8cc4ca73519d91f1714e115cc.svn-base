<?php
namespace common\libraries;


class SendNuoer
{

    protected static $send_plan_url = 'http://api.nuoer.vip/v1/recall/task/commit';
    protected static $send_plan_people_url = 'http://api.nuoer.vip/v1/recall/taskDetail/commit';
    private static  $key = 'dOW3Kjc2rGWsB1vkSKszuckEAwXuCTwR';
    private static $aes_key = 'PNlPzm28enDSuk8a';
    public static function sendPhone($msg)
    {

        $time = time();
        $post_data['plan_log_id'] = $msg[0]['id'];
        $arr_phone = array_column($msg,'phone');

        $post_data['phone'] = self::encrypt(json_encode($arr_phone));

        $post_data['time'] = $time;
        $post_data['sign'] = $post_data['plan_log_id'].$post_data['time'].self::$key;

        $result = self::request_by_curl(self::$send_plan_people_url, $post_data);
        $res = false;
        if($result['state']['code'] == 1){
            $res = true;
        }
        return $res;
   }

   public static function sendPlan($data)
   {

       $post_data = $data;
       $time = time();

       $post_data['time'] = $time;
       $post_data['sign'] = $data['platform'].$data['time'].self::$key;

       $result = self::request_by_curl(self::$send_plan_url, $post_data);
       $res = false;
       if($result['state']['code'] == 1){
           $res = true;
       }
       return $res;
   }


   private static function decrypt($content)
   {
       $decrypt = openssl_decrypt($content, 'AES-128-ECB', self::$aes_key, 0);
       return $decrypt;
   }

    private static function encrypt($content)
    {
        // 加密数据 'AES-128-ECB' 可以通过openssl_get_cipher_methods()获取
        $encrypt = openssl_encrypt($content, 'AES-128-ECB', self::$aes_key, 0);
        return $encrypt;

    }

    private static function request_by_curl($remote_server, $post_string) {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $remote_server);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array ('Content-Type: application/json;charset=utf-8'));
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_string);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        // 线下环境不用开启curl证书验证, 未调通情况可尝试添加该代码
        // curl_setopt ($ch, CURLOPT_SSL_VERIFYHOST, 0);
        // curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0);
        $data = curl_exec($ch);
        curl_close($ch);
        return $data;
    }
}