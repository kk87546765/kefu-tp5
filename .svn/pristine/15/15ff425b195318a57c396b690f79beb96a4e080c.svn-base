<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<body>
<div style="padding: 12px;"  class="search_wrap">
    <form class="layui-form" action="" id="search_form">
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">产品: </label>
            <div class="layui-input-inline">
                <select name="garrison_product_id"  lay-filter="garrison_product_id" id="product_id" lay-search="">

                </select>
            </div>
        </div>


        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">区服id: </label>
            <div class="layui-input-inline">
                <input type="text" name="server_id" id="server_id"  class="layui-input" >
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">组别: </label>
            <div class="layui-input-inline">
                <select name="admin_department_id"  lay-filter="admin_department_id" id="admin_department_id" lay-search="">
                    <option value="">选择或搜索</option>
                </select>
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">登录账号: </label>
            <div class="layui-input-inline">
                <input type="text" name="account" id="account"  class="layui-input" >
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">负责人: </label>
            <div class="layui-input-inline">
                <input type="text" name="admin_name" id="admin_name"  class="layui-input" >
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">进驻状态: </label>
            <div class="layui-input-inline">
                <select name="status"  lay-filter="status" id="status" lay-search="">
                    <option value="">选择或搜索</option>
                    <option value="0" >未进驻</option>
                    <option value="1" >进驻中</option>
                    <option value="2" >已抛服</option>
                    <option value="3" >已退服</option>
                </select>
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">进驻时间: </label>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="s_open_time" id="s_open_time" lay-verify="s_open_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="1" value="{{ date('Y-m-d 00:00:00') }}">
            </div>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="e_open_time" id="e_open_time" lay-verify="e_open_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="2" value="{{ date('Y-m-d 23:59:59') }}">
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">退服时间: </label>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="s_end_time" id="s_end_time" lay-verify="s_end_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="3" value="">
            </div>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="e_end_time" id="e_end_time" lay-verify="e_end_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="4" value="">
            </div>
        </div>
    </form>
</div>
<div class="layui-btn-group demoTable" style="padding: 0 15px; ">
    <button class="layui-btn layui-btn-sm" data-type="search">搜索</button>
    <button class="layui-btn layui-btn-sm" data-type="add">添加</button>
    <button type="button" id="refresh" class="layui-btn  layui-btn-sm">
        <i class="layui-icon layui-icon-refresh"></i>
    </button>

</div>
<div class="table_wrap" style="padding: 0 15px;">
    <table class="layui-table"  lay-filter="demo" id="idTest">
    </table>
</div>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
<script>
    var where = {};
    layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
        search: 'common/js/search',
    }).use(['table','common','jquery','form','laydate'], function(){
        var table   = layui.table,
            laydate = layui.laydate,
            $ = layui.jquery,
            common = layui.common,
            form = layui.form;


        //日期
        laydate.render({
            elem: '#s_open_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date().toLocaleDateString()),

        });
        laydate.render({
            elem: '#e_open_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(Date.parse(new Date().toLocaleDateString())+86400000),

        });


        //日期
        laydate.render({
            elem: '#s_end_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date().toLocaleDateString()),

        });
        laydate.render({
            elem: '#e_end_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(Date.parse(new Date().toLocaleDateString())+86400000),

        });



        table.render({
            elem: '#idTest'
            ,height: 'full-120'
            ,headers:common.getHeader()
            ,url: common.getUrl('account_registration/index') //数据接口
            ,page: true //开启分页
            ,limits:[20,50,100,200,500]
            ,limit:20

            ,cols: [[ //表头
                ,{field:'id', width:80,title:'id'}
                ,{field:'garrison_product_name', width:80, title:'产品'}
                ,{field:'server_id', minWidth:100, title:'区服id'}
                ,{field:'server_name', minWidth:100, title:'区服名称'}
                ,{field:'open_time', minWidth:120,  title:'开服时间'}
                ,{field:'admin_department_name', minWidth:150,title:'组别'}
                ,{field:'role_id', minWidth:150,   title:'内部角色ID'}
                ,{field:'role_name', minWidth:120,   title:'内部角色名'}
                ,{field:'password', minWidth:100,   title:'登陆密码'}
                ,{field:'account', minWidth:100,   title:'负责人'}
                ,{field:'start_time', minWidth:120,   title:'进驻时间'}
                ,{field:'end_time', minWidth:120,   title:'退服时间'}
                ,{field:'add_time', minWidth:120,   title:'首次添加时间'}
                ,{field:'login_time', minWidth:120,   title:'最后登录时间'}
                ,{minWidth:120, align:'center',title:'IP地址',templet: function(d){
                        let res = ip(d)
                        return res;
                    }}
                ,{minWidth:120, align:'center',title:'进驻状态',templet: function(d){
                        let res = action(d)
                        return res;
                    }}
                ,{minWidth:120, align:'center', toolbar: '#barDemo', fixed: 'right',  title:'操作'}
            ]]

        });




        //监听工具条
        table.on('tool(demo)', function(obj) {
            var data = obj.data;

            // var url = "/admin/distributional_server/block" + type[0].toUpperCase() + type.substr(1);

             if (obj.event === 'edit') {
                //添加
                layer.open({
                    type: 2,
                    title: "进驻信息登记界面",
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area: ['40%', '50%'],
                    content: "edit.html?id=" + data.id
                });
            } else if (obj.event === 'del') {
                 layer.confirm('真的删除行么', function(index){
                     layer.close(index);
                     common.req({
                         url: "account_registration/del",
                         data: { ids: data.id },
                         type: "get",
                         dataType:"json",
                         success:function(res){
                             if( res.code == 0 ){
                                 obj.del();
                                 layer.msg(res.msg,{icon:1});
                             }else{
                                 layer.msg(res.msg,{icon:2});
                             }
                         },
                         error:function(data){
                             layer.alert('错误'+data.msg,{icon:2});
                         }
                     });

                 });
            }
        })



        common.req({
            url: "ajax/getGarrisonProductList",
            type: "post",
            dataType:"json",
            success:function(data){

                $.each(data.data,function(k,v){
                    var optionstring = "";
                    $.each(data.data, function(i,item){
                        optionstring += "<option value=\"" + item.id + "\" >" + item.product_name + "</option>";
                    });

                    $("#product_id").html(optionstring);
                    form.render('select'); //这个很重要
                });


            },
            error:function(res){
                layer.alert('错误'+res.msg,{icon:2});
            }
        })


        common.req({
            url: "account_registration/getAdminDepartment",
            type: "post",
            dataType:"json",
            success:function(data){

                $.each(data.data,function(k,v){
                    var optionstring = "";
                    $.each(data.data, function(i,item){
                        optionstring += "<option value=\"" + item.id + "\" >" + item.name + "</option>";
                    });

                    $("#admin_department_id").html(optionstring);
                    form.render('select'); //这个很重要
                });


            },
            error:function(res){
                layer.alert('错误'+res.msg,{icon:2});
            }
        })


        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            if( type=='search' ){
                //搜索
                let form_data = $('#search_form').serializeArray();
                $.each(form_data,function(k,v){
                    where[v.name] = v.value;
                })
                console.log(where);
console.log(where);

                table.reload('idTest', {
                    method: 'post'
                    ,where: where
                    ,page: {
                        curr: 1
                    },
                });
            }else if( type=='add' ){
                //添加
                layer.open({
                    type: 2,
                    title: "添加登记信息",
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['40%' , '50%'],
                    content: "add.html"
                });
            }
        });
    });
    //给子级调用
    function res_msg(msg){
        layer.msg(msg,{icon:1});
        setTimeout(function(){
            window.location.reload();
        },1000);
    }


    function ip(d){
        var div = '';
        var str = '';
        if(d.ip_client){
            var str = d.ip_client;
            if(str.search("广州") < 0 ){
                div = "<div style='color:red;'>"+d.ip+"</div>";
            }else{
                div = "<div>"+d.ip+"</div>";
            }
        }else{
            div = "<div>"+d.ip+"</div>";
        }


        if(str.search("广州") < 0 ){
            div = "<div style='color:red;'>"+d.ip+"</div>";
        }else{
            div = "<div>"+d.ip+"</div>";
        }

        return div;
    }
    function action(d){
        var div = '';
        if(d.status == 3 ){
            div = '已退服'
        }else if(d.status == 2) {
            div = ' 已抛服'
        }else if(d.status == 0) {
            div = '未进驻'
        }else if(d.status == 1) {
            div = '进驻中'
        }

        return div;
    }

</script>
</body>
</html>