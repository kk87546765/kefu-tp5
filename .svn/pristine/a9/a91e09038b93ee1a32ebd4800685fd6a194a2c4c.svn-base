<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- 页面加载loading -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>
<!-- 正文开始 -->

<div class="layui-form" id="server_batch" action="" style="padding: 20px;display: none;">
    <input type="hidden" name="idStr" value="">
    <div class="layui-form-item" title="配置当前专员：转移配置中专员所属用户 其他：符合配置条件以及选中专员所属用户">
        <label class="layui-form-label">需转移专员</label>
        <div class="layui-input-inline">
            <select name="ascription_vip_old" lay-filter="ascription_vip_old" id="ascription_vip_old" lay-search="">
                <option value="0">配置当前专员</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新专员</label>
        <div class="layui-input-inline">
            <select name="ascription_vip" lay-filter="ascription_vip" id="ascription_vip" lay-search="">

            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" title="新专员修改为当前选中配置的专员">修改配置专员：</label>
        <div class="layui-input-inline" title="新专员修改为当前选中配置的专员">
            <input type="checkbox" name="is_save_admin" lay-skin="switch" lay-text="修改|否" value="1">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button type="submit" class="layui-btn" lay-submit="" lay-filter="submit_btn">立即提交</button>
        </div>
    </div>
</div>
<div style="padding: 12px;" class="search_wrap">
    <blockquote class="layui-elem-quote">
    <form class="layui-form" action="" lay-filter="search_form" id="search_form">
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">vip专员: </label>
            <div class="layui-input-inline">
                <select name="admin_user_id" lay-filter="admin_user_id" id="admin_user_id" lay-search="">
                    <option value=""></option>
                </select>
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">产品游戏: </label>
            <div class="layui-input-inline">
                <div id="select_game_product_id" class="xm-select-demo" style="min-width: 210px"></div>
            </div>
        </div>
    </form>
    </blockquote>
</div>

<div class="table_wrap table-tool-mini" style="padding: 0 15px;">
    <div class="layui-btn-group demoTable">
        <button class="layui-btn layui-btn-sm layui-power" id="VipConfig-serverManageList" data-type="search">搜索</button>
    </div>
    <table id="idTest" lay-filter="demo" class="layui-hide"></table>
</div>

<script>
    var pdata ={};
    var defaultToolbar = [
        'filter'
        , 'print'
        , 'exports'
    ];
    // var ids =[];
    var layui_obj = layui.config({
        //version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
    }).use(['common','jquery','table','laydate','xmSelect','form'], function(){
        var table   = layui.table,
            laydate = layui.laydate,
            xmSelect = layui.xmSelect,
            form = layui.form;
        var $ = layui.jquery;
        var common = layui.common;

        initData();

        // 行事件
        table.on('tool(demo)', function(obj){
            var data = obj.data;
            if(obj.event === 'serverManageDelete'){
                layer.confirm('真的删除行么', function(index){
                    layer.close(index);
                    common.req({
                        url: "vip_config/serverManageDelete",
                        data: { id: data.id },
                        type: "post",
                        dataType:"json",
                        success:function(res){
                            if( res.code==0 ){
                                // obj.del();
                                layer.msg(res.msg,{icon:1});
                                window.location.reload(); //刷新页面
                            }else{
                                layer.msg(res.msg,{icon:2});
                            }
                        },
                        error:function(data){
                            layer.alert('错误'+data.msg,{icon:2});
                        }
                    });

                });
            } else if(obj.event === 'add_game_product_server'){
                //编辑
                layer.open({
                    type: 2,
                    title: "修改",
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['85%' , '75%'],
                    content: "game_product_server_detail.html?id="+data.id
                });

            } else if(obj.event === 'adminGameServerList'){
                var url = "admin_game_server_list.html?ascription_game_server_id="+data.id;
                //编辑
                layer.open({
                    type: 2,
                    title: "修改",
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['85%' , '95%'],
                    content: url
                });
            }
        });

        // 头部工具监听事件
        table.on('toolbar(demo)', function(obj){
            switch(obj.event){
                case 'add':
                    //添加
                    layer.open({
                        type: 2,
                        title: "添加信息",
                        maxmin: true,
                        shadeClose: true, //点击遮罩关闭层
                        area : ['80%' , '60%'],
                        content: "game_product_server_detail.html"
                    });
                    break;
                case 'change':
                    var checkStatus = table.checkStatus('idTest')
                        ,data = checkStatus.data;

                    if( data.length<=0 ){
                        layer.msg("未选择任何行！",{icon:2});
                        return;
                    }

                    var ids = [];

                    for( var i=0; i<data.length; i++ ){
                        ids.push(data[i]['id']);
                    }

                    $('#server_batch').find('input[name="idStr"]').val(ids.join(','));

                    layer.open({
                        type: 1,
                        title: "批量转移区服",
                        maxmin: true,
                        shadeClose: true, //点击遮罩关闭层
                        area : ['65%' , '55%'],
                        content: $('#server_batch')
                    });
                    break;
            };
        });

        //自定义事件
        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            if( type=='search' ){
                //搜索
                let form_data = form.val('search_form');

                // console.log(form_data);return;
                $.each(form_data,function(k,v){
                    pdata[k] = v;
                })
                table.reload('idTest', {
                    method: 'post'
                    ,where: pdata
                    ,page: {
                        curr: 1
                    }
                });
            }
        });
        //批量转移区服
        form.on('submit(submit_btn)', function(data){
            data.field.idStr = data.field.idStr.split(',');

            if(data.field.ascription_vip_old == data.field.ascription_vip){
                layer.alert('新旧vip专员不能一样，请重新修改');
                return false;
            }

            common.req({
                url: "vip_config/serverManageChangeAdmin",
                data: data.field,
                type: "post",
                dataType:"json",
                success:function(json){
                    if( json.code == 0 ){
                        res_msg(json.msg);
                    }else{
                        layer.alert('错误'+json.msg,{icon:2});
                    }
                },
                error:function(json){
                    layer.alert('错误'+json.msg,{icon:2});
                }
            });
            return false;
        });
        function initData(){
            common.initPowerShow([
                'VipConfig-serverManageList'
            ]);

            if(common.hasPower('VipConfig-serverManageChangeAdmin')){
                defaultToolbar.unshift({
                    title: '批量转移区服' //标题
                    ,layEvent: 'change' //事件名，用于 toolbar 事件中使用
                    ,icon: 'layui-icon-user' //图标类名
                });
            }

            if(common.hasPower('VipConfig-serverManageAdd')){
                defaultToolbar.unshift({
                    title: '添加' //标题
                    ,layEvent: 'add' //事件名，用于 toolbar 事件中使用
                    ,icon: 'layui-icon-add-1' //图标类名
                });
            }

            common.req({
                url: "vip_config/serverManageListConfig",
                type: "post",
                dataType:"json",
                success:function(json){
                    var base_config = json.data.config;

                    $.each(base_config.admin_list,function(k,v){
                        $('select[name=admin_user_id]').append('<option value="'+v.id+'">'+v.name+'</option>');
                        $('select[name=ascription_vip]').append('<option value="'+v.id+'">'+v.name+'</option>');
                        $('select[name=ascription_vip_old]').append('<option value="'+v.id+'">'+v.name+'</option>');
                    });

                    var game_product_id_data = [];

                    $.each(base_config.game_product_list,function(k,v){
                        var this_data = {};
                        this_data.name = v.name;
                        this_data.value =v.id;
                        game_product_id_data.push(this_data);
                    });

                    var select_game_product_id = xmSelect.render({
                        el: '#select_game_product_id',
                        // radio: true,
                        toolbar: {
                            show: true,
                            list: [ 'ALL', 'CLEAR', 'REVERSE' ]
                        },
                        filterable:true,
                        data: game_product_id_data,
                        name:'game_product_id',
                        on:(data)=>{

                        },
                    })

                    form.render();
                },
                error:function(data){
                    layer.alert('错误'+data.msg,{icon:2});
                }
            });

            table.render({
                elem: '#idTest'
                ,height: 'full-120'
                ,url: common.getUrl('vip_config/serverManageList') //数据接口
                ,headers:common.getHeader()
                ,page: true
                ,limits:[20,50,100,200,500]
                ,limit:20
                ,autoWidth:true
                ,toolbar:'toolbar-test'
                ,defaultToolbar:defaultToolbar
                ,method:'POST'
                ,cols: [[ //表头
                    { type:'checkbox', minWidth:40, fixed: 'left' }
                    ,{field:'id', minWidth:80, title:'ID'}
                    ,{field:'admin_user_name', minWidth:120, title:'营销专员'}
                    ,{field:'game_product_name', minWidth:120, title:'产品游戏'}
                    ,{field:'blend_field', minWidth:1000, event:'show_config',title:'营销产品区服条件'}
                    ,{field:'add_admin_name', minWidth:120, title:'添加用户'}
                    ,{field:'add_time', minWidth:167, title:'添加时间'}
                    ,{field:'edit_admin_name', minWidth:120, title:'修改用户'}
                    ,{field:'edit_time', minWidth:167, title:'修改时间'}
                    ,{minWidth:180, align:'center', fixed: 'right', title:'操作'
                    ,templet:function(d){
                            let str = '';
                            if(d.action && d.action.length>0){
                                $.each(d.action,function(k,v){
                                    str+= action(v);
                                })
                            }
                            return str;
                        }
                    }
                ]]
                ,done:function(a,b,c){
                    lay_page = b;
                    if(c > 0){

                    }
                    common.isLoading(false);
                }
            });
        }
    });
    //给子级调用
    function res_msg(msg){
        layer.msg(msg,{icon:1});
        setTimeout(function(){
            window.location.reload();
        },1000);
    }
    function action(action,data){
        let str = '';
        switch (action) {
            case 'serverManageDetail':
                str = '<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="add_game_product_server">修改</a>';
                break;
            case 'serverManageDelete':
                str = '<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="serverManageDelete">剔除</a>';
                break;
            case 'adminGameServerList':
                str = '<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="adminGameServerList">关联数据</a>';
                break;
            default:

                break;
        }
        return str;
    }
</script>
</body>
</html>