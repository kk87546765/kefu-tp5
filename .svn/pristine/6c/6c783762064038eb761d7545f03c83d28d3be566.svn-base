<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<style type="text/css">
    .statistic{
        padding-left: 20px;
        padding-top: 15px;
    }
    .statistic li{
        display: inline-block;
        margin-right: 10px;
    }
</style>

<body>
<div style="padding: 12px;"  class="search_wrap">
    <form class="layui-form" action="" id="search_form">
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">产品: </label>
            <div class="layui-input-inline">
                <select name="garrison_product_id"  lay-filter="garrison_product_id" id="garrison_product_id" lay-search="">
                    <option value="">选择或搜索</option>

                </select>
            </div>
        </div>


        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">区服id: </label>
            <div class="layui-input-inline">
                <input type="text" name="server_id" id="server_id"  class="layui-input" >
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">负责人: </label>
            <div class="layui-input-inline">
                <input type="text" name="admin_name" id="admin_name"  class="layui-input" >
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">进驻状态: </label>
            <div class="layui-input-inline">
                <select name="status"  lay-filter="status" id="status" lay-search="">
                    <option value="">选择或搜索</option>
                    <option value="0" >未进驻</option>
                    <option value="1" >进驻中</option>
                    <option value="2" >已抛服</option>
                    <option value="3" >已退服</option>
                </select>
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">开服时间: </label>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="s_open_time" id="s_open_time" lay-verify="s_open_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="1" value="{{ date('Y-m-d 00:00:00') }}">
            </div>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="e_open_time" id="e_open_time" lay-verify="e_open_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="2" value="{{ date('Y-m-d 23:59:59') }}">
            </div>
        </div>
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">退服时间: </label>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="s_end_time" id="s_end_time" lay-verify="s_end_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="3" value="">
            </div>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="e_end_time" id="e_end_time" lay-verify="e_end_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="4" value="">
            </div>
        </div>
    </form>
</div>
<div class="layui-btn-group demoTable" style="padding: 0 15px;">
    <button class="layui-btn layui-btn-sm" data-type="search">搜索</button>
    <button class="layui-btn layui-btn-sm" data-type="total">统计</button>
    <button type="button" class="layui-btn layui-btn-sm layui-btn-warm" data-type="excel">
        <i class="layui-icon"></i>导出Excel
    </button>
    <button type="button" id="refresh" class="layui-btn  layui-btn-sm">
        <i class="layui-icon layui-icon-refresh"></i>
    </button>

</div>


<div class="table_wrap" style="padding: 0 15px;">
    <ul class="statistic" id="statistic">

    </ul>

    <table id='demo' lay-filter="demo" >
    </table>
</div>

<script type="text/html" id="check_chat">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="chat">查看</a>
</script>

<script type="text/html" id="check_pay_history">
    <a class="layui-btn layui-btn layui-btn-xs" lay-event="check_pay_history">查看</a>
</script>
<script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
<script>
    var where = {};
    layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
        search: 'common/js/search',
    }).use(['table','laydate','jquery','common','form'], function(){
        var table   = layui.table,
            laydate = layui.laydate,
            common = layui.common,
            form = layui.form,
            $ = layui.jquery;



        //日期
        laydate.render({
            elem: '#s_open_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date(new Date().toLocaleDateString())),

        });
        laydate.render({
            elem: '#e_open_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date(new Date().toLocaleDateString())),

        });


        // laydate.render({
        //     elem: '#s_end_time',
        //     trigger : 'click',
        //     type: 'datetime',
        //     format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
        //     value: new Date(new Date(new Date().toLocaleDateString())-86400000),
        //
        // });
        // laydate.render({
        //     elem: '#e_end_time',
        //     trigger : 'click',
        //     type: 'datetime',
        //     format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
        //     value: new Date(new Date(new Date().toLocaleDateString())),
        //
        // });


        //搜索
        let form_data = $('#search_form').serializeArray();
        $.each(form_data,function(k,v){
            where[v.name] = v.value;
        })

        //第一个实例
        table.render({
            elem: '#demo',
            headers:common.getHeader()
            ,height: 'full-150'
            ,where:where
            ,url: common.getUrl('server_turnover/index') //数据接口
            ,page: true //开启分页
            ,cols: [[ //表头
                {field:'garrison_product_name', width:80,title:'产品'}
                ,{field:'server_id',  minWidth:100,title:'区服id'}
                ,{field:'server_name', title: '区服名称', minWidth:100}
                ,{field:'open_time', title: '开服时间', minWidth:120}
                ,{field:'reg_num_1', title: '第1天注册数量', minWidth:150}
                ,{field:'reg_num_2', title: '第2天注册数量', minWidth:150}
                ,{field:'reg_num_total', title: '2天内注册数量', minWidth:150}
                ,{field:'role_id', title: '内部角色ID', minWidth:150}
                ,{field:'role_name', title: '内部角色名', minWidth:150}
                ,{field:'login_time', title: '最后登录时间', minWidth:120}
                ,{field:'is_end', title: '是否抛服', minWidth:120}
                ,{field:'status', title: '进驻状态', minWidth:120}
                ,{field:'start_time', title: '进驻时间', minWidth:120}
                ,{field:'admin_name', title: '负责人', minWidth:120}
                ,{field:'ltv', title: 'LTV', minWidth:120}
                ,{field:'money', title: '累计充值', minWidth:120}
                ,{field:'platform_id', title: '平台id', minWidth:120}
                ,{field:'money_1', minWidth:100,title:'第1天充值'}
                ,{field:'money_2', minWidth:100,title:'第2天充值'}
                ,{field:'money_3', minWidth:100,title:'第3天充值'}
                ,{field:'money_4', minWidth:100,title:'第4天充值'}
                ,{field:'money_5', minWidth:100,title:'第5天充值'}
                ,{field:'money_6', minWidth:100,title:'第6天充值'}
                ,{field:'money_7', minWidth:100,title:'第7天充值'}
                ,{field:'money_8', minWidth:100,title:'第8天充值'}
                ,{field:'money_9', minWidth:100,title:'第9天充值'}
                ,{field:'money_10', minWidth:100,title:'第10天充值'}
                ,{field:'money_11', minWidth:100,title:'第11天充值'}
                ,{field:'money_12', minWidth:100,title:'第12天充值'}
                ,{field:'money_13', minWidth:100,title:'第13天充值'}
                ,{field:'money_14', minWidth:100,title:'第14天充值'}
                ,{field:'money_15', minWidth:100,title:'第15天充值'}
                ,{field:'money_16', minWidth:100,title:'第16天充值'}
                ,{field:'money_17', minWidth:100,title:'第17天充值'}
                ,{field:'money_18', minWidth:100,title:'第18天充值'}
                ,{field:'money_19', minWidth:100,title:'第19天充值'}
                ,{field:'money_20', minWidth:100,title:'第20天充值'}
                ,{field:'money_21', minWidth:100,title:'第21天充值'}
                ,{field:'money_22', minWidth:100,title:'第22天充值'}
                ,{field:'money_23', minWidth:100,title:'第23天充值'}
                ,{field:'money_24', minWidth:100,title:'第24天充值'}
                ,{field:'money_25', minWidth:100,title:'第25天充值'}
                ,{field:'money_26', minWidth:100,title:'第26天充值'}
                ,{field:'money_27', minWidth:100,title:'第27天充值'}
                ,{field:'money_28', minWidth:100,title:'第28天充值'}
                ,{field:'money_29', minWidth:100,title:'第29天充值'}
                ,{field:'money_30', minWidth:100,title:'第30天充值'}

                ,{field:'money_60', minWidth:100,title:'前60天充值'}
                ,{field:'money_90', minWidth:100,title:'前90天充值'}
                ,{field:'money_120', minWidth:100,title:'前120天充值'}

                ]]

        });

        common.req({
            url: "ajax/getGarrisonProductList",
            type: "post",
            dataType:"json",
            success:function(data){

                var optionstring = "";
                optionstring = "<option value='' >请选择</option>";
                $("#garrison_product_id").html(optionstring);

                $.each(data.data, function(i,item){


                    optionstring += "<option value=\"" + item.id + "\" >" + item.product_name + "</option>";
                });
                $("#garrison_product_id").html(optionstring);
                form.render('select'); //这个很重要
            },
            error:function(res){
                layer.alert('错误'+res.msg,{icon:2});
            }


        })

        //监听工具条
        table.on('tool(demo)', function(obj) {
            var data = obj.data;

            // var url = "/admin/distributional_server/block" + type[0].toUpperCase() + type.substr(1);
            if (obj.event === 'check_pay_history') {
                var url = "check_pay_history.html?server_id=" + data['server_id']+'&product_id=' + data['product_id']+'&platform_id=' + data['platform_id'] + '&open_time=' + data['open_time'];
                //聊天
                layer.open({
                    type: 2,
                    title: "查看历史充值",
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area: ['90%', '60%'],
                    content: url
                });
            };
        })



        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            if( type=='search' ){
                //搜索
                let form_data = $('#search_form').serializeArray();
                $.each(form_data,function(k,v){
                    where[v.name] = v.value;
                })

                table.reload('demo', {
                    method: 'post',
                    url: common.getUrl('server_turnover/index')
                    ,where: where
                    ,page: {
                        curr: 1
                    }

                });
            }else if(type=='total'){

                var garrison_product_id   = $('#garrison_product_id').val(),
                    server_id     = $('#server_id').val(),
                    admin_name    = $('#admin_name').val(),
                    status        = $('#status').val(),

                    s_open_time   = $('#s_open_time').val(),
                    e_open_time   = $('#e_open_time').val(),
                    s_end_time    = $('#s_end_time').val(),
                    e_end_time    = $('#e_end_time').val();



                common.req({
                    url: "server_turnover/getCount",
                    data: { server_id: server_id ,garrison_product_id:garrison_product_id,admin_name:admin_name,status:status,s_open_time:s_open_time,e_open_time:e_open_time,s_end_time:s_end_time,e_end_time:e_end_time},
                    type: "post",
                    dataType:"json",
                    success:function(res){


                        var statistic_info = {
                            'garrison_product_name':'产品',
                            'server_id':'区服id',
                            'server_name':'区服名称',
                            'open_time':'开服时间',
                            'reg_num':'注册人数',
                            'money':'累计金额',
                        };
                        if( res.code == 0 ){
                            var info = res.data[0]
                            var html = '';
                            $.each(statistic_info,function(k,v){

                                html += '<li>'+v+': <span>'+info[k]+'</span></li>';

                            })
                            $('#statistic').html(html);
                        }
                    },

                });
            }else if( type=='excel' ){
                loading = layer.load(1, {shade: [0.3, '#fff']});
                var excel = layui.excel;


                //搜索
                let form_data = $('#search_form').serializeArray();
                $.each(form_data,function(k,v){
                    where[v.name] = v.value;
                })
                where['is_excel'] = 1;
                common.req({
                    url: 'server_turnover/index',
                    dataType: 'json',
                    type: "post",
                    data: where,
                    success: function(res) {
                        layer.close(loading);
                        layer.msg(res.msg);
                        // 假如返回的 res.data 是需要导出的列表数据

                        // 1. 数组头部新增表头
                        res.data.unshift({
                            garrison_product_name: '产品',
                            server_id: '区服id',
                            server_name: '区服名称',
                            open_time: '开服时间',
                            reg_num: '注册数量',
                            role_id: '内部角色ID',
                            role_name: '内部角色名',
                            login_time: '最后登录时间',
                            is_end: '是否抛服',
                            status: '进驻状态',
                            start_time: '进驻时间',
                            admin_name: '负责人',
                            ltv: 'LTV',
                            money:'累计充值',
                            money_1:'第1天充值',
                            money_2:'第2天充值',
                            money_3:'第3天充值',
                            money_4:'第4天充值',
                            money_5:'第5天充值',
                            money_6:'第6天充值',
                            money_7:'第7天充值',
                            money_8:'第8天充值',
                            money_9:'第9天充值',
                            money_10:'第10天充值',
                            money_11:'第11天充值',
                            money_12:'第12天充值',
                            money_13:'第13天充值',
                            money_14:'第14天充值',
                            money_15:'第15天充值',
                            money_16:'第16天充值',
                            money_17:'第17天充值',
                            money_18:'第18天充值',
                            money_19:'第19天充值',
                            money_20:'第20天充值',
                            money_21:'第21天充值',
                            money_22:'第22天充值',
                            money_23:'第23天充值',
                            money_24:'第24天充值',
                            money_25:'第25天充值',
                            money_26:'第26天充值',
                            money_27:'第27天充值',
                            money_28:'第28天充值',
                            money_29:'第29天充值',
                            money_30:'第30天充值',
                            total_money_60:'前60天充值',
                            total_money_90:'前90天充值',
                            total_money_120:'前120天充值',

                        });
                        // 3. 执行导出函数，系统会弹出弹框
                        excel.exportExcel({
                            sheet1: res.data
                        }, '区服统计列表.xlsx', 'xlsx');
                    },
                    error:function(res){
                        layer.close(loading);
                        layer.msg(res.msg);
                    }
                });
            }
        });
    });
    //给子级调用
    function res_msg(msg){
        layer.msg(msg,{icon:1});
        setTimeout(function(){
            window.location.reload();
        },1000);
    }


    function action(d){
        var div = '';
        if(d.status == 3 || d.is_end == 1){
            div += '<a>已退服</a>'

        }else {
            div += ' <a class=\'layui-btn layui-btn-danger layui-btn-xs\' lay-event=\'del\'>退服</a>'


        }


        if(d.status == 2 ){
            div += '<a>已抛服</a>'

        }else{
            div += ' <a class=\'layui-btn layui-btn-danger layui-btn-xs\' lay-event=\'del\'>抛服</a>'
        }


        return div;
    }

</script>
</body>
</html>