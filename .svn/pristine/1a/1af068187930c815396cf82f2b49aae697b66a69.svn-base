{% include 'common/header_layui.volt' %}
<style>
    .laytable-cell-checkbox .layui-disabled.layui-form-checked i {
        background: #fff !important;
    }
    .statistic{
        padding-left: 20px;
        padding-top: 15px;
    }
    .statistic li{
        display: inline-block;
        margin-right: 10px;
    }
</style>


<body>
<div style="padding: 12px;"  class="search_wrap">
    <form class="layui-form" action="" id="search_form">

        <div class="layui-inline">
            <label class="layui-form-label">生日</label>
            <div class="layui-input-inline" style="width: 90px;">
                <input type="text" name="birthday_start"  value="" id="birthday_start" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-input-inline" style="width: 90px;">
                <input type="text" name="birthday_end"  value="" id="birthday_end" autocomplete="off" class="layui-input">
            </div>
            <!-- <div class="layui-input-inline" style="width: 150px;">
                <input type="text" name="add_time_end"  value="" id="add_time_end" autocomplete="off" class="layui-input">
            </div> -->
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">分组: </label>
            <div class="layui-input-inline">
                <select name="group_id">
                    <option value="">全部</option>
                    {% for k,v in config['group_list'] %}
                    <option value="{{v['id']}}">{{v['name']}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">游戏: </label>
            <div class="layui-input-inline">
                <select name="p_p" lay-search>
                    <option value="">全部</option>
                    {% for k,v in config['game_list'] %}
                    <option value="{{v['id_str']}}">{{v['name']}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">专员: </label>
            <div class="layui-input-inline">
                <select name="ascription_vip" lay-search>
                    <option value="">全部</option>
                    {% for k,v in config['admin_list'] %}
                    <option value="{{v['id']}}">{{v['realname']}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="layui-inline">
           <label class="layui-form-label">总充值金额</label>

           <div class="layui-input-inline" style="width: 100px;">
               <input type="number" name="total_pay_start" min="0"  placeholder="" autocomplete="off" class="layui-input">
           </div>
           -
           <div class="layui-input-inline" style="width: 100px;">
               <input type="number" name="total_pay_end" min="0" placeholder="" autocomplete="off" class="layui-input">
           </div>

       </div>
        <div class="layui-inline">
           <label class="layui-form-label">近30天累充</label>

           <div class="layui-input-inline" style="width: 100px;">
               <input type="number" name="thirty_day_pay_start" min="0"  placeholder="" autocomplete="off" class="layui-input">
           </div>
           -
           <div class="layui-input-inline" style="width: 100px;">
               <input type="number" name="thirty_day_pay_end" min="0" placeholder="" autocomplete="off" class="layui-input">
           </div>

       </div>

    </form>
</div>
<div class="layui-btn-group demoTable" style="padding: 0 30px; float: right;">
    <button type="button" id="refresh" class="layui-btn  layui-btn-sm">
        <i class="layui-icon layui-icon-refresh"></i>
    </button>
    <button class="layui-btn layui-btn-sm" data-type="search">搜索</button>
</div>
<div>
    <!-- <ul class="statistic">
        <li id="count">搜索工单数：<span>0</span></li>
        <li id="sum_sell_amount">销售总金额：<span>0</span></li>
        <li id="pass_sell_amount">过审金额：<span>0</span></li>
        <li id="no_sell_amount">待审金额：<span>0</span></li>
        <li id="count_uid">人数：<span>0</span></li>
    </ul> -->
</div>
<div class="table_wrap" style="padding: 0 15px;">
    <table id="idTest" lay-filter="demo" class="layui-table"></table>
</div>



<script>
    var qc_index;
    var lay_page = 1;
    var pdata = {};
    var lay_obj = layui.use(['table','form','laydate'], function(){
        var table   = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;

         //日期
        laydate.render({
            elem: '#birthday_start',
            trigger : 'click',
            // type: 'datetime'
        });
        laydate.render({
            elem: '#birthday_end',
            trigger : 'click',
            // type: 'datetime'
        });

        // //日期
        // laydate.render({
        //     elem: '#add_time_end',
        //     trigger : 'click',
        //     type: 'datetime'
        // });

       
        table.render({
            elem: '#idTest'
            ,height: 'full-120'
            ,url: '/admin/{{controller}}/vip_user_privacy_info_list' //数据接口
            ,page: true
            ,limits:[20,50,100,200,500]
            ,limit:20
            ,minWidth:1000
            ,where:pdata
            ,method:'post'
            ,cols: [[ //表头
                {field:'id', minWidth:80, sort: true, title:'ID'}
                ,{field:'user_name', minWidth:90, title:'用户名'}
                ,{field:'platform_id_str', minWidth:90, title:'平台'}
                ,{field:'server_name', minWidth:90, title:'游戏'}
                ,{field:'server_id', minWidth:90, title:'区服'}
                ,{field:'role_name', minWidth:90, title:'角色名'}
                ,{field:'role_id', minWidth:90, title:'角色ID'}
                ,{field:'total_pay', minWidth:120, title:'总充值金额'}
                ,{field:'thirty_day_pay', minWidth:120, title:'近30天累充'}
                ,{field:'charge_status', minWidth:90, title:'充值状态'}
                ,{field:'birthday_str', minWidth:90, title:'生日'}
                ,{field:'qq', minWidth:90, title:'QQ号码'}
                ,{field:'ascription_vip_str', minWidth:90, title:'专员'}
                // ,{field:'platform_id_str', minWidth:90, title:'平台类型'}
                ,{minWidth:180, align:'center', fixed: 'right', title:'操作'
                ,templet:function(d){
                        let str = '';
                        if(d.action && d.action.length>0){
                            $.each(d.action,function(k,v){
                                str+= action(v);
                            })
                        }
                        return str;
                    }
                }
            ]]
            ,done:function(a,b,c){
                lay_page = b;

                console.log(a,b,c);
                // console.log(b);
                // console.log(c);
                // console.log(c);
            }
        });

        //监听工具条
        table.on('tool(demo)', function(obj){
            var data = obj.data;
            if(obj.event === 'del'){
                layer.confirm('真的删除行么', function(index){
                    layer.close(index);
                    $.ajax({
                        url: "/admin/{{controller}}/del",
                        data: { ids: data.id },
                        type: "post",
                        dataType:"json",
                        success:function(res){
                            if( res.status==1 ){
                                obj.del();
                                layer.msg(res.msg,{icon:1});
                            }else{
                                layer.msg(res.msg,{icon:2});
                            }
                        },
                        error:function(data){
                            layer.alert('错误'+data.msg,{icon:2});
                        }
                    });

                });
            }else if(obj.event === 'detail'){
                var title='编辑';
                var url = '/admin/{{controller}}/vip_user_other_info_detail?id='+data.id;

                var this_index = layer.open({
                    type: 2,
                    title: title+'详情',
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['70%' , '70%'],
                    content: url
                });

                layer.full(this_index);
            }else if(obj.event === 'vip_user_welfare_save'){
                var title='添加福利';
                var url = '/admin/vipwelfare/vip_user_welfare_detail?p_u='+data.platform_id+'_'+data.uid;
                var this_index = layer.open({
                    type: 2,
                    title: title,
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['70%' , '70%'],
                    content: url
                });

                layer.full(this_index);
            }else if(obj.event === 'vip_user_welfare_list'){
                var title='添加福利';
                var url = '/admin/vipwelfare/vip_user_welfare_list?p_u='+data.platform_id+'_'+data.uid;
                var this_index = layer.open({
                    type: 2,
                    title: title,
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['70%' , '70%'],
                    content: url
                });

                layer.full(this_index);
            }

        });



        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            if( type=='add' ){
                //添加
                layer.open({
                    type: 2,
                    title: "添加",
                    maxmin: true,
                    shadeClose: true, //点击遮罩关闭层
                    area : ['70%' , '70%'],
                    content: "/admin/{{controller}}/vip_user_other_info_detail"
                });
            }else if( type=='search' ){
                //搜索
                let form_data = $('#search_form').serializeArray();
                // console.log(form_data);return;
                $.each(form_data,function(k,v){
                    pdata[v.name] = v.value;
                })
                table.reload('idTest', {
                    method: 'post'
                    ,where: pdata
                    ,page: {
                        curr: 1
                    }
                });
            }else if( type=='excel' ){
                loading = layer.load(1, {shade: [0.3, '#fff']});
                var excel = layui.excel;
                console.log(excel)
                //搜索
                let form_data = $('#search_form').serializeArray();
                // console.log(form_data);return;
                var this_where = {
                    is_excel:1
                    ,limit:0
                };
                $.each(form_data,function(k,v){
                    this_where[v.name] = v.value;
                })
                $.ajax({
                    url: '/admin/{{controller}}/vip_user_privacy_info_list',
                    dataType: 'json',
                    type: "post",
                    data: this_where,
                    success: function(res) {
                        layer.close(loading);
                        layer.msg(res.msg);
                        // 假如返回的 res.data 是需要导出的列表数据
                        console.log(res.data);//
                        // 1. 数组头部新增表头
                        if (res.code == 0) {

                            res.data.unshift({
                                id:'ID'
                                ,type_str:'工单类型'
                                ,sell_type_str:'销售类型'
                                ,kf_id_str:'VIP专员'
                                ,user_name:'玩家账号'
                                ,server_id:'区服'
                                ,product_id_str:'游戏'
                                ,status_str:'审核状态'
                                ,sell_amount:'订单金额'
                                ,pay_time_str:'成交时间'
                                ,add_time_str:'录单时间'
                                ,qc_first_time_str:'初审时间'
                                ,qc_second_time_str:'复审时间'
                                ,reason:'拒审原因'
                                ,chum_reason:'流失原因'
                            });
                            // 3. 执行导出函数，系统会弹出弹框
                            excel.exportExcel({
                                sheet1: res.data
                            }, '工单列表.xlsx', 'xlsx');
                        }
                    },
                    error:function(res){
                        layer.close(loading);
                        layer.msg(res.msg);
                    }
                });
            }
        });
        
    });
    //给子级调用
    function res_msg(msg){
        layer.msg(msg,{icon:1});
        setTimeout(function(){
            // window.location.reload();
            lay_obj.table.reload('idTest', {
                method: 'post'
                ,where: pdata
                ,page: {
                    curr: lay_page
                }
            });
        },1000);
    }

    function action(action,data){
        let str = '';
        switch (action) {
            case 'vip_user_other_info_detail':
                str = '<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>';
                break;
            case 'vip_user_welfare_save':
                str = '<a class="layui-btn layui-btn-xs" lay-event="vip_user_welfare_save">添加福利</a>';
                break;
            case 'vip_user_welfare_list':
                str = '<a class="layui-btn layui-btn-xs" lay-event="vip_user_welfare_list">历史福利</a>';
                break;
            default:

                break;
        }

        return str;
    }
</script>
</body>
</html>