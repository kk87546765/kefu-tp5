<?php


use extend\GamekeySign\GamekeySignBase;

class nbcq2youyu extends GamekeySignBase
{

    public $from = 'cp-channel-yy';
    public $secret = 'kbIukodaJEr1dXaDkEZTXv2SXd26qJiJ';

    public $uid_to_sdkid_url = "http://data-service.tanwan.com/customerService/user-info/mul-search-uid";
    public $sdkid_to_uid_url = "http://data-service.tanwan.com/customerService/user-info/mul-search-openid";

    private $cooperationID = [355=>'zw',50180=>'youyu'];

    public function __construct(){

    }

    #根据平台自身的uid换cp给的聚合uid，用于调用cp封禁、禁言接口
    public function uid_to_sdkid_url($sdkid){

        if(empty($sdkid)){
            return false;
        }
        $time = time();
        $sign = md5($this->secret.$time);
        $data['openid_list']= json_encode([$sdkid]);
        $data['from'] = $this->from;
        $data['ts'] = $time;
        $data['sign'] = $sign;
        $url = $this->uid_to_sdkid_url.'?'.urldecode(http_build_query($data));

        $res = $this->fetchUrl($url);
        $res = json_decode($res,1);
        if($res['code'] == 200){
            if(isset($res['data'][$sdkid])){

                $return_info['uid'] = $res['data'][$sdkid]['uid'];
                $return_info['sdkid'] = $res['data'][$sdkid]['openid'];
                $return_info['tkey'] = isset($res['data'][$sdkid]['channel']) && key_exists($res['data'][$sdkid]['channel'],$this->cooperationID) ? $this->cooperationID[$res['data'][$sdkid]['channel']] : '';

                return $return_info;
            }else{
                return false;
            }

        }else{
            return false;
        }
    }

    #根据cp给的聚合uid换成平台自身的uid，用于信息推送时候替换成自己平台的uid
    public function sdkid_to_uid_url($sdkid){

        if(empty($sdkid)){
            return false;
        }
        $time = time();
        $sign = md5($this->secret.$time);
        $data['uid_list']= json_encode([$sdkid]);
        $data['from'] = $this->from;
        $data['ts'] = $time;
        $data['sign'] = $sign;
        $url = $this->sdkid_to_uid_url.'?'.urldecode(http_build_query($data));

        $res = $this->fetchUrl($url);
        $res = json_decode($res,1);

        if($res['code'] == 200){
            if(isset($res['data'][$sdkid])){


                $return_info['uid'] = $sdkid;
                $return_info['sdkid'] = $res['data'][$sdkid]['openid'];
                $return_info['tkey'] = isset($res['data'][$sdkid]['channel']) && key_exists($res['data'][$sdkid]['channel'],$this->cooperationID) ? $this->cooperationID[$res['data'][$sdkid]['channel']] : '';

                return $return_info;
            }else{
                return false;
            }

        }else{
            return false;
        }

    }






}