<?php

namespace extend\Sms;

use TencentCloud\Common\Credential;
use TencentCloud\Common\Profile\ClientProfile;
use TencentCloud\Common\Profile\HttpProfile;
use TencentCloud\Common\Exception\TencentCloudSDKException;
use TencentCloud\Sms\V20210111\SmsClient;
use TencentCloud\Sms\V20210111\Models\SendSmsRequest;
use think\Db;
//use app\extend\ApiLog;
class TencentSms
{
    static public $secretId = "AKIDW3LM6Zmi02mMfhRu61f39yVpse9NL2RZ";
    static public $secretKey = "tVquhDRP6VdV6QUHn20h6E5fy0mH5ex4";
    static public $endpoint = "sms.tencentcloudapi.com";
    static public $region = "ap-guangzhou";
    static public $smsSdkAppId = "1400642885";

    public static $type = [
        'notice'=>'1342131',
        'code'=>'1342129',
    ];

    static public function sendSms($phone = [], $tempSet = [], $tempId = "1342129", $signName = "流连互娱网络")
    {

        $return = ['status'=>false,'msg'=>''];
        $send = false;
        $params = [];
        try {
            $cred = new Credential(self::$secretId, self::$secretKey);
            $httpProfile = new HttpProfile();
            $httpProfile->setEndpoint(self::$endpoint);

            $clientProfile = new ClientProfile();
            $clientProfile->setHttpProfile($httpProfile);
            $client = new SmsClient($cred, self::$region, $clientProfile);

            $req = new SendSmsRequest();

            foreach ($tempSet as &$item) {
                $item = str_ireplace('Cost', 'C*st', $item);//腾讯云短信不能发生带cost单词的短信
            }

            $params = [
                "PhoneNumberSet" => $phone,
                "SmsSdkAppId" => self::$smsSdkAppId,
                "SignName" => $signName,
                "TemplateId" => $tempId,
                "TemplateParamSet" => $tempSet,
            ];

            $req->fromJsonString(json_encode($params));

            $resp = $client->SendSms($req);

            $respJsonStr = $resp->toJsonString();

            trace("TencentSms response toJsonString error:" . $respJsonStr, "error");

            $statusSet = json_decode($respJsonStr, true)['SendStatusSet'];
            trace("TencentSms response 1 " . json_encode($statusSet));

            $status = array_unique(array_column($statusSet, "Code"));
            trace("TencentSms response 2 " . json_encode($status));


            if (strtolower(array_shift($status)) == "ok") {
                $send = true;
                $return['status'] = $send;
            }

        } catch (\Exception $e) {
            $params = ['err'=>$e->getMessage()];
            trace("TencentSms response error:" . $e->getMessage(), "error");
        }

        $return['msg'] = json_encode($params);

        return $return;
    }
    public static function getTempId($defaul = "notice"){
        return self::$type[$defaul];
    }
}

