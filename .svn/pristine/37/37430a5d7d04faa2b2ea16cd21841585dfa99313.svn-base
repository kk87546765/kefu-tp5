<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
</head>
<style>
   .top,.mid,.btm{
        margin-bottom: 20px;
   }
   .sell_amount_span{
        line-height: 30px;
        font-size: 16px;
        margin-left: 20px;
   }
   .content{
        position: relative;
   }
   .top{
        position: fixed;
        top: 0;
        /*min-height: 100px;*/
        background: #fff;
        z-index: 800;
        padding-top: 10px;
        min-height: 100px;
        /*width: 100%;*/
   }
   .info_status_div{
    padding-bottom: 10px;
   }
   .info_status_btn{
        text-align: right;
        position: absolute;
        bottom: 0;
        right: 0;
   }
   .info_status{
/*        position: absolute;
        bottom: 0;
        left: : 0;*/
        max-width: 650px;
        margin-top: 10px;
        margin-left: 10px;
   }
   .info_status_reason{
        max-width: 450px;
        padding-left: 10px;
        /* display: inline-block;*/
        word-wrap: break-word;
        word-break: break-all;
   }
   .lxx_title{
        margin-top: 0;
   }
</style>
<div id="qc_div" style="display: none;padding-top: 15px;">

    <div class="layui-form-item" >
        <label class="layui-form-label">不通过原因: </label>
        <div class="layui-input-inline">
            <textarea name="qc_reason" style="min-height: 120px;min-width: 250px"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <span type="submit" class="layui-btn qc_submit" attr-val="{{info['status']}}" attr-type="no">确认</span>
        </div>
    </div>

</div>
<body class="hold-transition skin-blue sidebar-mini">
<form class="layui-form" lay-filter="edit-form" action="" style="padding: 20px;" onsubmit="return false;">
    <div class="content search_wrap">
        <div class="top" id="this_top">
            <div class="layui-row layui-col-space10">

                <div class="layui-inline" id="id_model">
                    <label class="layui-form-label">工单ID: </label>
                    <div class="layui-input-inline">
                        <input type="text" name="id" disabled autocomplete="off" class="layui-input"
                        value="" 
                        >
                    </div>
                </div>

                <div class="layui-inline" >
                    <label class="layui-form-label">用户账号: </label>
                    <div class="layui-input-inline">
                        <input type="text" name="user_name" disabled autocomplete="off" class="layui-input"
                        value="" 
                        >
                    </div>
                </div>

                <div class="layui-inline control control_1 control_3" >
                    <label class="layui-form-label">区服: </label>
                    <div class="layui-input-inline">
                        <select name="server_id" lay-filter="server_id" id="server_id" >
                        </select>
                    </div>
                </div>

                <div class="layui-inline" >
                    <label class="">专员: </label>
                    <div class="layui-input-inline">
                        <select name="kf_id" lay-filter="kf_id" lay-verify="required" disabled>
                        </select>
                    </div>
                </div>

                <div class="layui-inline control control_2" >
                    <label class="">销售类型: </label>
                    <div class="layui-input-inline">
                        <select name="sell_type" lay-filter="sell_type" lay-verify="required" >
                        </select>
                    </div>
                </div>

                <div class="layui-inline control control_2" >
                    <label class="">销售次数: </label>
                    <div class="layui-input-inline">
                        <select name="is_first" lay-filter="is_first" lay-verify="required" >
                        </select>
                    </div>
                </div>

                <div class="layui-inline" >
                    <label class="">游戏名称: </label>
                    <div class="layui-input-inline select">
                        <select name="product_id" lay-verify="required" lay-filter="product_id" id="product_id" lay-search>
                        </select>
                    </div>
                </div>

                <div class="layui-inline" >
                    <label class="">联系方式: </label>
                    <div class="layui-input-inline select">
                        <select name="contact_type" lay-verify="required" lay-filter="contact_type" id="contact_type" >
                        </select>
                    </div>
                </div>

                <div class="layui-inline control control_4" >
                    <label class="layui-form-label">召回账号: </label>
                    <div class="layui-input-inline">
                        <input type="text" name="recall_account" lay-verify="control_type"  autocomplete="off" class="layui-input"
                        value="" 
                        >
                    </div>
                </div>

                <div class="layui-inline control control_4" >
                    <label class="layui-form-label">召回时间: </label>
                    <div class="layui-input-inline">
                        <input id="recall_time" type="text" name="recall_time" lay-verify="control_type"  autocomplete="off" class="layui-input"
                        value="" 
                        >
                    </div>
                </div>

                <div class="layui-inline control control_5" >
                    <label class="layui-form-label">流失原因: </label>
                    <div class="layui-input-inline">
                        <input id="chum_reason" type="text" name="chum_reason" lay-verify="control_type"  autocomplete="off" class="layui-input"
                        value="">
                    </div>
                </div>
            </div>

            <div class="info_status_div">
                <p class="info_status">
                    审核状态:<span style="max-width: 100px;padding-left: 10px;"></span><br>
                </p>

                <p class="info_status_btn">
                    <span class="layui-power" id="Vip-sellWorkOrderQcFirst">
                        <span type="submit" class="layui-btn qc_submit" attr-val="" attr-type="yes" >通过</span>
                        <span type="submit" class="layui-btn layui-btn-warm qc_submit_no">不通过</span>
                    </span>
                    <span class="layui-power" id="Vip-sellWorkOrderQcSecond">
                        <span type="submit" class="layui-btn qc_submit" attr-val="" attr-type="yes" >通过</span>
                        <span type="submit" class="layui-btn layui-btn-warm qc_submit_no">不通过</span>
                    </span>
                    <span type="submit" class="layui-btn layui-btn-normal qc_submit_next">下一单</span>
                </p>


            </div>

            <div class="top_order_list control control_2">
                <div class="lxx_title">订单</div>
                <div style="padding: 12px;"  class="search_wrap">

                    <div class="layui-inline" style="margin-bottom: 6px;">
                        <label class="layui-form-label">订单时间: </label>
                        <div class="layui-input-inline">
                            <input id="order_time_start" type="text" name="order_time_start" lay-verify="control_type"  autocomplete="off" class="layui-input"
                            value="" 
                            >
                        </div>
                        <span id="second_time">
                            -
                            <div class="layui-input-inline">
                                <input id="order_time_end" type="text" name="order_time_end" lay-verify="control_type"  autocomplete="off" class="layui-input"
                                value="" 
                                >
                            </div>
                        </span>
                    </div>
                </div>

                <div class="layui-btn-group demoTable">
                    <span class="layui-btn demoTableBtn layui-btn-sm" data-type="search">搜索</span>
                    <span class='layui-inline sell_amount_span '>订单总额：<i id="sum_amount"></i></span>
                </div>
            </div>
        </div>
        <div id="def_top" style="height: 15px;"></div>
        <div class="mid control control_2">
            <div class="table_wrap">
                <table id="idTest" lay-filter="demo" class="layui-table"></table>
            </div>
        </div>

        <div class="btm">
            <div class="layui-row layui-col-space10">
                <textarea id="editor" style="min-height:800px;" name="content"></textarea>
            </div>
            
        </div>


        <input type="hidden" name="type" value="">
        <input type="hidden" name="uid" value="">
        <input type="hidden" name="platform_id" value="">
        <input type="hidden" name="game_id" value="">
        <div class="layui-form-item">
            <div class="layui-input-block">
              <button type="submit" class="layui-btn layui-power my_submit" id="Vip-sellWorkOrderEdit" lay-submit="" lay-filter="submit_btn">修改</button>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
              <button type="submit" class="layui-btn layui-power my_submit" id="Vip-sellWorkOrderAdd" lay-submit="" lay-filter="submit_btn">立即提交</button>
            </div>
        </div>
    </div>

</form>

<script type="text/javascript" charset="utf-8" src="/assets/plug/uediortext/ueditor.config.js?t=1"></script>
<script type="text/javascript" charset="utf-8" src="/assets/plug/uediortext/ueditor.all.js"> </script>
<script>
var ue = UE.getEditor('editor');
var checked_order_ids = [];
var tld = [];
var qc_index;

var detail_info = {};
var user_info = {
    product_id:0
};
var where = {};

var layui_obj = layui.config({
    //version: true,
    base: '/assets/model/'
}).extend({
    common: 'common/js/common',
}).use(['common','jquery','form','layedit','laydate','table'], function(){
    var form = layui.form;//
    var layedit = layui.layedit;//
    var laydate = layui.laydate;//
    var table = layui.table;//

    var $ = layui.jquery;
    var common = layui.common;
    
    var url = 'vip/kefuPayOrderList';
    var p_url = "vip/sellWorkOrderAdd";

    //日期
    laydate.render({
        elem: '#recall_time',
        trigger : 'click',
        type: 'datetime'
    });
    laydate.render({
        elem: '#order_time_start',
        trigger : 'click',
        type: 'datetime'
    });
    laydate.render({
        elem: '#order_time_end',
        trigger : 'click',
        type: 'datetime'
    });

    initData();

    $('.demoTableBtn').on('click', function(){
        var type = $(this).data('type');
        if( type=='search' ){
            //搜索
            where.order_time_start = $('input[name="order_time_start"]').val();
            where.order_time_end = $('input[name="order_time_end"]').val();
            console.log(where)
            table.reload('idTest', {
                method: 'post'
                ,where: where
                ,page: {
                    curr: 1
                }
            });
        }
    });

    //监听工具条
    table.on('tool(demo)', function(obj){
        var data = obj.data;
        if(obj.event === 'del'){
            layer.confirm('真的删除行么', function(index){
                layer.close(index);
                common.req({
                    url: "/admin/{{controller}}/del",
                    data: { ids: data.id },
                    type: "post",
                    dataType:"json",
                    success:function(res){
                        if( res.code==0 ){
                            obj.del();
                            layer.msg(res.msg,{icon:1});
                        }else{
                            layer.msg(res.msg,{icon:2});
                        }
                    },
                    error:function(data){
                        layer.alert('错误'+data.msg,{icon:2});
                    }
                });

            });
        }else if(obj.event === 'detail'){
            var title='编辑';
            var url = '/admin/{{controller}}/sell_work_order_detail?id='+data.id;

            layer.open({
                type: 2,
                title: title+'详情',
                maxmin: true,
                shadeClose: true, //点击遮罩关闭层
                area : ['70%' , '70%'],
                content: url
            });
        }
    });

    form.on('checkbox(siam_one)', function(data){
        sumOrderCheck();
    })

    form.on('select(sell_type)',function(data){
        where.sell_type = data.value;
    })
    //监听提交
    form.on('submit(submit_btn)', async function(data){
        var content = ue.getContent();
        data.field.content = content;
        data.field.update_time = detail_info.update_time;
        $('.my_submit').attr('disabled','disabled');

        if(detail_info.id==0){

            if(detail_info.is_first == 1 && user_info.product_id != data.field.product_id){

                var promise = new Promise((resolve, reject) => {
                    layer.confirm('选择游戏与用户最后充值游戏不符'
                        , function(index){
                            resolve(1)
                            layer.close(index);
                        }, function(index){
                            resolve(0)
                        }
                    );
                })
                var flag = await promise;
                if(!flag){
                    $('.my_submit').removeAttr('disabled');
                    return false;
                }
            }
        }

        if(detail_info.type == 2){
            data.field.order_ids = checked_order_ids;
        }

        common.req({
            url: p_url,
            data: data.field,
            type: "post",
            dataType:"json",
            success:function(res){
                if( res.code==0 ){
                    var index = parent.layer.getFrameIndex(window.name);
                    window.parent.res_msg(res.msg);
                    parent.layer.close(index);//关闭当前页
                }else{
                    $('.my_submit').removeAttr('disabled');
                    layer.msg(res.msg,{icon:2});

                }

            },
            error:function(res){
                $('.my_submit').removeAttr('disabled');
                layer.alert('错误'+res.msg,{icon:2});

            }
        });

        return false;
    });

    //监听游戏选择切换
    form.on('select(product_id)',function(data){
        if(detail_info.type == 2){
            where.product_id = data.value;

            table.reload('idTest', {
                method: 'post'
                ,where: where
                ,page: {
                    curr: 1
                }
            });
        }else{
            
            setServerSelectByProductId(data.value);
        }
        
    })

    form.on("checkbox(siam_all)", function () {
        var status = $(this).prop("checked");
        $.each($("input[name=siam_one]"), function (i, value) {
            $(this).prop("checked", status);
        });
        form.render();
        sumOrderCheck();
    });

    $('.qc_submit_no').click(function(){
        qc_index = layer.open({
            type: 1,
            title: '原因',
            maxmin: true,
            shadeClose: true, //点击遮罩关闭层
            area : ['440px' , '260px'],
            content: $('#qc_div'),
        });
    })

    $('.qc_submit_next').click(()=>{
        var url = '/admin/ajax/getSellWorkNextId';

        var this_pdata = window.parent.pdata;
        this_pdata.not_search_id = detail_info.id;
        common.req({
            url:url
            ,dataType:'json'
            ,data:this_pdata
            ,type: "post"
            ,success:(res)=>{
                if(res.code == 0){
                    var this_url = '/admin/vip/sell_work_order_detail?id='+res.data.id;
                    location.href = this_url;
                }else{
                    layer.msg(res.msg);
                }
            }
            ,error:(res)=>{
                layer.alert('错误'+res.msg,{icon:2});
            }
        });
    })

    $('.qc_submit').click(function(){
        var this_obj = $(this);
        var val = this_obj.attr('attr-val');
        var type = this_obj.attr('attr-type');
        var p_data = {};
            p_data.id = $('input[name="id"]').val();
        if(val == 0){
            var url = 'vip/sellWorkOrderQcFirst';
        }else{
            var url = 'vip/sellWorkOrderQcSecond';
        }

        if(type == 'yes'){
            if(val == 0){
                p_data.status = 1;
            }else{
                p_data.status = 2;
            }
        }else{
            p_data.reason = $('textarea[name="qc_reason"]').val();
            if(!p_data.reason){
                layer.alert('请填写不通过原因');
                return false;
            }

            if(val == 0){
                p_data.status = -1;
            }else{
                p_data.status = -2;
            }
        }

        common.req({
            url: url,
            data: p_data,
            type: "post",
            dataType:"json",
            success:function(res){
                if( res.code==0 ){
                    // layer.msg(res.msg,{icon:1});
                    if(type == 'no'){
                        layer.close(qc_index)
                    }
                    setTimeout(()=>{
                        window.location.reload();
                        window.parent.res_msg(res.msg);
                    },1500)
                    
                }else{
                    layer.msg(res.msg,{icon:2});
                }
            },
            error:function(data){
                layer.alert('错误'+data.msg,{icon:2});
            }
        });

    })

    form.verify({
      control_type: function(value, item){ //value：表单的值、item：表单的DOM对象
            if(detail_info.type == 1 || detail_info.type == 3){
                switch (item.name) {
                    case 'server_id':
                        if(!value){
                            return '请正确填写区服';
                        }
                        break;
                    
                    default:
                        break;
                }
            }else if(detail_info.type == 2){

            }else if(detail_info.type == 4){

                switch (item.name) {
                    case 'recall_time':
                        if(!value){
                            return '请选择召回时间';
                        }
                        break;
                    
                    default:
                        break;
                }
            }
            return false;
      }
       
    });

    function initData(){

        common.req({
            url: 'vip/sellWorkOrderDetail',
            data: common.urlParam,
            type: "post",
            dataType:"json",
            success:function(res){
                
                if( res.code==0 ){
                    detail_info = res.info;
                    user_info = res.uri_info;
                    var base_config = res.config;
                    var action = res.action;

                    if(detail_info.id >0){
                        p_url = "vip/sellWorkOrderEdit"
                        $('#id_model').show();
                        ue.setContent(detail_info.content);
                        $('.info_status').show();
                        var info_status_str = '审核状态:<span style="max-width: 100px;padding-left: 10px;">'+detail_info.status_str+'</span><br>';
                        if(detail_info.status == -1 || detail_info.status == -2){
                            info_status_str+= '拒绝理由:<p class="info_status_reason">'+detail_info.reason+'</p><br>'
                        }
                        $('.info_status').html(info_status_str);
                        if(common.hasPower('Vip-sellWorkOrderQcFirst') || common.hasPower('Vip-sellWorkOrderQcSecond') ){
                            $('.info_status_btn').show();
                        }
                        $('.qc_submit').attr('attr-val',detail_info.status);
                        $('#sum_amount').html(detail_info.sell_amount);
                    }else{
                        $('#id_model').hide();
                        $('.info_status').hide();
                        $('.info_status_btn').hide();
                    }

                    $('#sum_amount').html(detail_info.sum_amount);

                    common.initPowerShow(action);

                    init();

                    where.uid = detail_info.uid;
                    where.platform_id = detail_info.platform_id;
                    where.sell_work_order_id = detail_info.id;
                    where.order_time_start = detail_info.order_time_start;
                    where.order_time_end = detail_info.order_time_end;
                    where.product_id = detail_info.product_id;
                    where.sell_type = detail_info.sell_type;


                    if(detail_info.type == 2){
                        table.render({
                            elem: '#idTest'
                            ,height: 'full-120'
                            ,url: common.getUrl(url)
                            ,headers:common.getHeader()
                            ,page: false //开启分页
                            ,limits:[50,100,200,500]
                            ,limit:0
                            ,minWidth:1000
                            ,height:400
                            ,where:where
                            ,method:'POST'
                            ,cols: [[ //表头
                                {
                                    title:"<input type='checkbox' name='siam_all' title='' lay-skin='primary' lay-filter='siam_all'>"
                                    , width:50
                                    , fixed: 'left'
                                    ,templet:function(d){
                                        var str = '';
                                        if(!d.LAY_DISABLE){

                                            str = '<input type="checkbox" lay-filter="siam_one" name="siam_one" title="" lay-skin="primary" data-id = "'+d.id+'"';

                                            if(d.LAY_CHECKED) str+=' checked ';

                                            str += '>';
                                        }
                                        

                                        return str;
                                    }
                                }
                                ,{
                                    title:"上次"
                                    , width:80
                                    , fixed: 'left'
                                    ,templet:function(d){

                                        var str = '<input type="checkbox" disabled name="siam_one_old" title="" lay-skin="primary" data-id = "'+d.id+'"';

                                        if(d.LAY_CHECKED) str+=' checked ';

                                        return str+'>';
                                    }
                                }
                                ,{field:'order_id', minWidth:80, title:'订单ID'}
                                ,{field:'amount', minWidth:80, title:'充值金额'}
                                ,{field:'game_name', minWidth:150, title:'游戏'}
                                ,{field:'server_id', minWidth:150, title:'区服'}
                                ,{field:'role_id', minWidth:150, title:'角色ID'}
                                ,{field:'role_name', minWidth:150, title:'角色名'}
                                ,{field:'payment_str', minWidth:120, title:'支付渠道'}
                                ,{field:'pay_time_str', minWidth:150, title:'日期'}
                            ]]
                            ,done:function(res){
                                $.each(res.data,function(k,v){
                                    tld[v.id] = v;
                                })
                                if(detail_info.status >= 0){
                                    sumOrderCheck();
                                }
                            }
                        });
                    }

                    $.each(base_config.kf_list,function(k,v){
                        $('select[name=kf_id]').append('<option value="'+v.id+'">'+v.name+'</option>');
                    });

                    $.each(base_config.game_list,function(k,v){
                        $('select[name=product_id]').append('<option value="'+v.product_id+'">'+v.name+'</option>');
                    });

                    $.each(base_config.sell_type_arr,function(k,v){
                        $('select[name=sell_type]').append('<option value="'+k+'">'+v+'</option>');
                    });

                    $.each(base_config.is_first_arr,function(k,v){
                        $('select[name=is_first]').append('<option value="'+k+'">'+v+'</option>');
                    });

                    $.each(base_config.contact_type_arr,function(k,v){
                        $('select[name=contact_type]').append('<option value="'+k+'">'+v+'</option>');
                    });

                    form.val('edit-form',detail_info);

                    form.render();

                }else{
                    layer.alert('错误'+res.msg,{icon:2});
                }
            },
            error:function(res){
                layer.alert('错误'+res.msg,{icon:2});
            }
        });
    }

    function init(){
    
        changeType(detail_info.type);
        var top_height = $('#this_top').css('height');
        $('#def_top').css('margin-top',top_height);
        setServerSelectByProductId(detail_info.product_id);
    }

    function sumOrderCheck() {
        var ids = [];
        var amount = 0;
        $.each($(".layui-table-fixed-l input[name=siam_one]:checked"), function (i, value) {
            var this_id = $(this).attr("data-id");
            var this_data = tld[this_id];
            amount += parseFloat(this_data.amount);
            
            ids[i] = this_id;  // 如果需要获取其他的值 需要在模板中把值放到属性中 然后这里就可以拿到了
        });

        $('#sum_amount').html(amount);
        checked_order_ids = ids;
    }

    function changeType(type){

        $('.control').hide();
        $('.control').css('height',0);
        
        if(type!=0){

            $('.control_'+type).show();
            $('.control_'+type).css('height','auto');
        }

    }

    function setServerSelectByProductId(pid){
        var where = {};
        where.product_id = pid;
        where.uid = detail_info.uid;
        where.platform_id = detail_info.platform_id;
        common.req({
            url: "vip/getVipUserServerInfoByGameId",
            data: where,
            type: "post",
            dataType:"json",
            success:function(res){
                $('#server_id').html('');
                if( res.code==0 ){

                    $.each(res.data,function(k,v){
                        if(v.server_id == $('#server_id').attr('data-val')){
                            $('#server_id').append('<option selected value="'+v.server_id+'">'+v.server_id+'</option>');
                        }else{
                            $('#server_id').append('<option  value="'+v.server_id+'">'+v.server_id+'</option>');
                        }
                    })

                }else{
                    // layer.msg(res.msg,{icon:2});
                }
                

                form.render('select');
            },
            error:function(res){
                layer.alert('错误'+res.msg,{icon:2});
            }
        });
    }
});
   



   


</script>
</body>
</html>