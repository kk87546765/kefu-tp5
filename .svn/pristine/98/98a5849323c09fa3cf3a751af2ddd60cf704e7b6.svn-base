<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<body>

<table id="demo" lay-filter="demo"></table>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="block">封号</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="chat">禁言</a>
</script>
<script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
<script>
    layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
        search: 'common/js/search',
    }).use(['table','common','jquery'], function(){
        var table   = layui.table,
            $   = layui.jquery,
            common   = layui.common;


        var pdata = common.urlParam;
        //第一个实例
        table.render({
            elem: '#demo',
            headers:common.getHeader()
            ,height: 'full-150'
            ,where:{'uid':pdata.uid}
            ,url: common.getUrl('block/check_chat3') //数据接口
            ,page: false //开启分页
            ,cols: [[ //表头
                 {field:'uid', minWidth:120,title:'用户ID'}
                ,{field:'uname', minWidth:120,title:'角色名'}
                ,{field:'role_level', minWidth:80,title:'角色等级'}
                ,{field:'ip', minWidth:150,title:'IP'}
                ,{field:'date', title: '时间', minWidth:100}
                ,{field:'count_money', minWidth:100,title:'充值金额'}
                ,{field:'game_name', minWidth:100,title:'游戏'}
                ,{field:'content', minWidth:200,title:'内容'}
                ,{field:'time', minWidth:200,title:'时间',hide:true}
                ,{field:'gkey', minWidth:200,title:'游戏key',hide:true}
                ,{title: '操作',minWidth:160, align:'center', toolbar: '#barDemo', fixed: 'right'}


            ]]
            ,parseData:function(res){

                console.log(res);return  false;
                if(res.code != 0){

                    layer.msg(res.msg,{icon:2});
                    res.msg = '获取失败';
                }

                return {
                    'code' : res.code,
                    'msg' : res.msg,
                    'data' : res.data,
                    'count' : res.count,
                }
            }
            ,limit:20

        });


        //监听工具条
        table.on('tool(demo)', function(obj){
            var data = obj.data;
            console.log(data.id)
            if(obj.event === 'block'){
                if(data.status == 1){
                    layer.alert('账号已封');
                    return;
                }

                layer.open({

                    title:'时长选择',

                    content:"<input type=\"text\" name=\"block_time\" id=\"block_time\" autocomplete=\"off\" class=\"layui-input\" placeholder=\"小时\" >",
                    yes:function(index,layero){
                        var block_time = $('#block_time').val();

                        var ids = [];
                        var uids = [];
                        ids.push(data['id']);
                        uids.push(data['uid']);
                        var type = 'blockUser';
                        var block_txt = "确定封禁选中用户吗？"
                        layer.confirm( block_txt, function(index){
                            layer.close(index);

                            var url ="block/"+type;


                            block_fun(url,ids,block_time,uids);
                        });
                    }
                });

            }else if(obj.event === 'chat'){


                if(data.platform_key == '渠道平台'){
                    layer.alert('渠道平台请去cp后台处理');
                    return;
                }


                layer.open({

                    title:'时长选择',

                    content:"<input type=\"text\" name=\"block_time\" id=\"block_time\" autocomplete=\"off\" class=\"layui-input\" placeholder=\"小时\" >",
                    yes:function(index,layero){
                        var block_time = $('#block_time').val();

                        var ids = [];
                        var uids = [];
                        ids.push(data['id']);
                        uids.push(data['uid']);
                        var type = 'blockChat'
                        var block_txt = "确定禁言选中角色吗？"
                        layer.confirm( block_txt, function(index){
                            layer.close(index);

                            var url ="block/"+type;

                            block_fun(url,ids,block_time,uids);
                        });
                    }
                });
            }

        });


        //封禁操作
        function block_fun(url,ids,block_time,uids){

            if(block_time != ''){
                block_time = block_time*3600;
            }

            common.req({
                url: url,
                data: { a_ids: ids ,block_time:block_time,uids:uids},
                type: "post",
                dataType:"json",
                success:function(res){
                    if( res.status ){
                        var msg = "封禁成功："+res.succ+"<br/>"+"封禁失败："+res.fail+"<br/>"+"重复封禁："+res.isBlocked;
                        layer.alert(msg);
                    }else{
                        layer.alert(res.msg);
                    }
                },
            });
        }


        $(document).keyup(function(e){
            var key =  e.which || e.keyCode;
            if(key == 27){
                var index = parent.layer.getFrameIndex(window.name);

                parent.layer.close(index)
            }
        });

    });


</script>
</body>
</html>