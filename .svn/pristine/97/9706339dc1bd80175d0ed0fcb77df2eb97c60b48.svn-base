<?php
/**
 * Created by PhpStorm.
 * User: crosstime
 * Date: 2017/10/12
 * Time: 上午11:57
 */
namespace common\server\RecallPlan;


use common\base\BasicServer;
use common\model\db_customer\RecallCodeGroup;
use common\server\Vip\LossUserServer;
use common\server\Platform\{Platform};
use common\server\Vip\RecallServer;
use common\libraries\Common;

use common\sql_server\{RecallPlanLogSqlServer, RecallPlanPeopleLogSqlServer, RecallPlanSqlServer};
use think\Config;


class RecallPlanServer extends BasicServer
{

    //根据计划表写入计划记录表
    public static function executeLossPlan($params)
    {
        $result = ['code'=>1, 'data'=>[]];

        //
        $where = ['status'=>1,'execute_type'=>1];
        $res = RecallPlanSqlServer::getInfo($where);
        $res = isset($res) ? $res->toArray() : [];

        foreach($res as $k=>$v){

            $tmp_data = self::dealParams($v);

            $res = RecallPlanLogSqlServer::insertInfo($tmp_data);
            $return_arr[$v['id']] = $res;
        }
        $result = $return_arr;
        return $result;

    }


    //根据计划记录表写入计划记录明细表
    public static function executeLossPlanLog($params)
    {
        $where = ['status'=>1,'execute_type'=>1];
        $plan_logs = RecallPlanLogSqlServer::getInfo($where);

        foreach($plan_logs as $k=>$v)
        {
            //筛选符合计划的用户
            LossUserServer::screenUids($v);
        }


        $tmp_data = self::dealParams2($params);


        RecallPlanPeopleLogSqlServer::insertInfo($tmp_data);
    }


    public static function dealParams($data)
    {
        $tmp_data = $data;
        $code_ids = RecallServer::getCodeByGroupId($data['recall_code_group_id']);
        $ver_ids = RecallServer::getLinkByGroupId($data['recall_ver_group_id']);

        $tmp_data['recall_code_id'] = implode(',',$code_ids);
        $tmp_data['recall_ver_id'] = implode(',',$ver_ids);
        $tmp_data['exec_date'] = date('Y-m-d');
        $tmp_data['add_time'] = time();
        $tmp_data['plan_id'] = $data['id'];
//        $tmp_data['platform_id'] = $data['id'];
        return $tmp_data;
    }

    public static function dealParams2($data)
    {
        $tmp_data = $data;


        $tmp_data['plan_log_id'] = $data['id'];

        $tmp_data['last_login_time'] = $data['last_login_time'];
        $tmp_data['add_time'] = time();
        $tmp_data['plan_id'] = $data['id'];
//        $tmp_data['platform_id'] = $data['id'];
        return $tmp_data;
    }

}