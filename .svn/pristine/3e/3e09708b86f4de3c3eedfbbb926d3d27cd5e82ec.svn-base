<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<body>
<div style="padding: 12px;"  class="search_wrap">
    <form class="layui-form" action="" id="search_form">
        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">产品: </label>
            <div class="layui-input-inline">
                <select id="garrison_product_id"   style="width: 300px">

                </select>
            </div>
        </div>



        <div class="layui-inline" style="margin-bottom: 6px;">
            <label class="layui-form-label">日期筛选: </label>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="s_open_time" id="s_open_time" lay-verify="s_open_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="1" value="{{ date('Y-m-d 00:00:00') }}">
            </div>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text" name="e_open_time" id="e_open_time" lay-verify="e_open_time" placeholder="YYYY-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" lay-key="2" value="{{ date('Y-m-d 23:59:59') }}">
            </div>
        </div>

    </form>
</div>
<div class="layui-btn-group demoTable" style="padding: 0 15px; ">
    <button class="layui-btn layui-btn-sm" data-type="search">搜索</button>
    <button type="button" class="layui-btn layui-btn-sm layui-btn-warm" data-type="excel">
        <i class="layui-icon"></i>导出Excel
    </button>
    <button type="button" id="refresh" class="layui-btn  layui-btn-sm">
        <i class="layui-icon layui-icon-refresh"></i>
    </button>

</div>
<div class="table_wrap" style="padding: 0 15px;">
    <table id="idTest" lay-filter="demo" class="layui-table"></table>
</div>



<script type="text/html" id="check_chat">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="chat">查看</a>
</script>
<script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
<script>

    layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
        search: 'common/js/search',
    }).use(['table','laydate','xmSelect','common','jquery','form','excel'], function(){
        var table   = layui.table,
            laydate = layui.laydate,
            $ = layui.jquery,
            common = layui.common,
            form = layui.form,
            excel = layui.excel,
            xmSelect = layui.xmSelect;

        //日期
        laydate.render({
            elem: '#s_open_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date(new Date().toLocaleDateString())-86400000),

        });
        laydate.render({
            elem: '#e_open_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date(new Date().toLocaleDateString())),

        });

        //日期
        laydate.render({
            elem: '#s_end_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date(new Date().toLocaleDateString())-86400000),

        });
        laydate.render({
            elem: '#e_end_time',
            trigger : 'click',
            type: 'datetime',
            format: 'yyyy-MM-dd HH:mm:ss', //指定时间格式
            value: new Date(new Date(new Date().toLocaleDateString())),

        });



        table.render({
            elem: '#idTest'
            ,height: 'full-120'
            ,headers:common.getHeader()
            ,url: common.getUrl('settled/ltvIndex') //数据接口
            ,page: true //开启分页
            ,where:where
            ,limits:[20,50,100,200,500]
            ,limit:20
            ,minWidth:1000
            ,cols: [[ //表头
                ,{field:'date', width:100, title:'日期'}
                ,{field:'ltv_in_server_7', minWidth:80, title:'满7天入驻服LTV'}
                ,{field:'ltv_no_server_7', minWidth:80, title:'满7天轮空服LTV'}
                ,{field:'performance_in_server_7', minWidth:150, title:'满7天入驻服提效'}
                ,{field:'ltv_in_server_14', minWidth:80, title:'满14天入驻服LTV'}
                ,{field:'ltv_no_server_14', minWidth:80, title:'满14天轮空服LTV'}
                ,{field:'performance_in_server_14', minWidth:150, title:'满14天入驻服提效'}
                ,{field:'ltv_in_server_30', minWidth:80, title:'满30天入驻服LTV'}
                ,{field:'ltv_no_server_30', minWidth:80, title:'满30天轮空服LTV'}
                ,{field:'performance_in_server_30', minWidth:150, title:'满30天入驻服提效'}
            ]]
        });


        common.req({
            url: "ajax/getGarrisonProductList",
            type: "post",
            dataType:"json",
            success:function(data){
                var product_id_data = [];
                $.each(data.data,function(k,v){
                    var optionstring = "";
                    $.each(data.data, function(i,item){
                        console.log(item)
                        optionstring += "<option value=\"" + item.id + "\" >" + item.product_name + "</option>";
                    });
                    $("#garrison_product_id").html(optionstring);
                    form.render('select'); //这个很重要
                });


            },
            error:function(res){
                layer.alert('错误'+res.msg,{icon:2});
            }


        })



        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            if( type=='search' ){
                //搜索
                var garrison_product_id   = $('#garrison_product_id').val(),
                s_open_time   = $('#s_open_time').val(),
                e_open_time   = $('#e_open_time').val();

                table.reload('idTest', {
                    method: 'post'
                    ,where: {
                        'garrison_product_id': garrison_product_id,
                        's_open_time': s_open_time,
                        'e_open_time': e_open_time
                    }
                    ,page: {
                        curr: 1
                    },
                });
            }else if( type=='excel' ){
                loading = layer.load(1, {shade: [0.3, '#fff']});
                var excel = layui.excel;

                var garrison_product_id   = $('#garrison_product_id').val();

                var s_open_time   = $('#s_open_time').val();
                var e_open_time   = $('#e_open_time').val();

                $.ajax({
                    url: '/admin/settled/excel_2',
                    dataType: 'json',
                    type: "post",
                    data: {
                        'garrison_product_id'  :  garrison_product_id,
                        's_open_time'  :  s_open_time,
                        'e_open_time'  :  e_open_time,


                    },

                    success: function(res) {
                        layer.close(loading);
                        layer.msg(res.msg);
                        // 假如返回的 res.data 是需要导出的列表数据
                        console.log(res.data);//
                        // 1. 数组头部新增表头
                        res.data.unshift({
                            date: '日期',
                            ltv_in_server_7: '满7天入驻服LTV',
                            ltv_no_server_7: '满7天轮空服LTV',
                            performance_in_server_7: '满7天入驻服提效',
                            ltv_in_server_14: '满14天入驻服LTV',
                            ltv_no_server_14: '满14天轮空服LTV',
                            performance_in_server_14: '满14天入驻服提效',
                            ltv_in_server_30: '满30天入驻服LTV',
                            ltv_no_server_30: '满30天轮空服LTV',
                            performance_in_server_30: '满30天入驻服提效',

                        });
                        // 3. 执行导出函数，系统会弹出弹框
                        excel.exportExcel({
                            sheet1: res.data
                        }, '日入驻ltv统计.xlsx', 'xlsx');
                    },
                    error:function(res){
                        layer.close(loading);
                        layer.msg(res.msg);
                    }
                });
            }
        });
    });
    //给子级调用
    function res_msg(msg){
        layer.msg(msg,{icon:1});
        setTimeout(function(){
            window.location.reload();
        },1000);
    }

    function rtrim(str,char){
        var pos = str.lastIndexOf(char);

        var sonstr = str.substr(0,pos);

        return sonstr;
    }

    function action(d){
        var div = '';
        if(d.server_status == 3 ){
            div = '已退服'
        }else if(d.server_status == 2) {
            div = ' 已抛服'
        }else if(d.server_status == 0) {
            div = '未进驻'
        }else if(d.server_status == 1) {
            div = '进驻中'
        }

        return div;
    }

</script>
</body>
</html>