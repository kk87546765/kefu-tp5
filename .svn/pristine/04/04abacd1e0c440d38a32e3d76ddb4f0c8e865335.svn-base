<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="/assets/vendor/layui/css/layui.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/style.css"/>
    <link rel="stylesheet" href="/assets/model/common/css/common.css"/>
    <script type="text/javascript" src="/assets/vendor/layui/layui.js"></script>
    <!--[if lt IE 9]>
    <script src="/assets/model/common/js/html5shiv.min.js"></script>
    <script src="/assets/model/common/js/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-col-space15 {
            /* margin: -7.5px; */
            margin:-7.5px 0 !important;
        }
    </style>
</head>
<body>
<!-- 页面加载loading -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>
<!-- 正文开始 -->

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body table-tool-mini">
            <div class="layui-form toolbar" lay-filter="edit-form">
                <div class="layui-form-item">
                    <blockquote class="layui-elem-quote">
                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">关键词：</label>
                            <div class="layui-input-inline">
                                <input name="keyword" id="keyword" type="text" class="layui-input" placeholder="工单编号/角色ID/账号" autocomplete="off">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">平台类型：</label>
                            <div class="layui-input-inline">
                                <select name="platform_id" id="platform_id" lay-filter="platform_id">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">工单类型：</label>
                            <div class="layui-input-inline">
                                <select name="sheet_type" id="sheet_type" lay-filter="sheet_type">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">操作类型：</label>
                            <div class="layui-input-inline">
                                <select name="sheet_item_type" id="sheet_item_type">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">状态：</label>
                            <div class="layui-input-inline">
                                <select name="status" id="status">
                                    <option value="-1">请选择</option>
                                </select>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">添加时间：</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="add_time" name="add_time" value="" placeholder=" - " autocomplete="off">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">警告数据：</label>
                            <div class="layui-input-inline">
                                <select name="is_tips" id="is_tips">
                                    <option value="">请选择</option>
                                    <option value="1">是</option>
                                </select>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">记录人：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <div id="select_record_user" class="xm-select-demo" style="min-width: 210px"></div>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">跟进人：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <div id="select_follow_user" class="xm-select-demo" style="min-width: 210px"></div>
                            </div>
                        </div>

                        <input type="hidden" name="static_type" value="">

                        <button class="layui-btn icon-btn table-search-btn layui-power" style="margin-top: -5px;" lay-filter="table-search" id="WorkSheet-list" lay-submit>
                            <i class="layui-icon">&#xe615;</i>查询
                        </button>
                    </blockquote>
                </div>
            </div>
            <div class="layui-form">
                <div class="layui-inline">
                    <label class="layui-form-label">我的工单：</label>
                    <div class="layui-input-inline">
                        <input type="checkbox" name="open" lay-skin="switch" lay-filter="myWorkSheet" id="myWorkSheet" lay-text="ON|OFF">
                    </div>
                </div>
            </div>
            <table class="layui-hide" id="table-list" lay-filter="table-list"></table>

            <div class="layui-fluid">
                <div class="layui-fluid" style="text-align: cdetailenter">
                    <div id="tablePage"></div>
                </div>
            </div>

        </div>
    </div>
</div>



<script>
    var showMyWorkSheet = 0;//是否只显示我的工单
    var p_data = {
        'sheet_type':0
        ,'showMyWorkSheet':showMyWorkSheet
    };
    var lay_page = 1;
    var layui_obj = layui.config({
        version: true,
        base: '/assets/model/'
    }).extend({
        common: 'common/js/common',
    }).use(['common','jquery','form','laydate','xmSelect','table'], function () {
        var form = layui.form,
            table = layui.table,
            xmSelect = layui.xmSelect,
            laydate = layui.laydate;
        var $ = layui.jquery;
        var common = layui.common;

        var page = 1;
        var limit = 20;
        var downLoadUrl = 'work_sheet/downLoad';//导出
        var topStateUrl = 'work_sheet/top';//置顶或取消置顶操作
        var deleteUrl = 'work_sheet/del';//删除
        var get_scheet_type_config_url = 'work_sheet/getSheetTypeConfig';
        

        //日期范围
        laydate.render({
            elem: '#add_time',
            range: true,
        });

        var admin_list = [];

        var select_record_user = xmSelect.render({
            el: '#select_record_user',
            toolbar: {
                show: true,
                list: [ 'ALL', 'CLEAR', 'REVERSE' ]
            },
            filterable: true,
            data: admin_list,
            name:'record_user',
            on:function(data){
                //arr:  当前多选已选中的数据
                var arr = data.arr;
                //change, 此次选择变化的数据,数组
                var change = data.change;
                //isAdd, 此次操作是新增还是删除
                var isAdd = data.isAdd;
                
            },
        })
        var select_follow_user = xmSelect.render({
            el: '#select_follow_user',
            toolbar: {
                show: true,
                list: [ 'ALL', 'CLEAR', 'REVERSE' ]
            },
            filterable: true,
            data: admin_list,
            name:'follow_user',
            on:function(data){
                //arr:  当前多选已选中的数据
                var arr = data.arr;
                //change, 此次选择变化的数据,数组
                var change = data.change;
                //isAdd, 此次操作是新增还是删除
                var isAdd = data.isAdd;
                
            },
        })

        // 表格请求初始化
        var cols = [[
            {'type':'checkbox','fixed':'left'}
            ,{'title':'工单编号','align':'center','fixed':'left','width':210,templet:function(d){
                    if(d.is_tips == 1){
                        return '<span style="color: red;">'+d.sheet_num+'</span>';
                    }else{
                        return d.sheet_num;
                    }
            }}
            
            ,{'title':'工单类型','minWidth':98,'field':'sheet_type_str'}
            ,{'title':'操作类型','minWidth':200,'field':'sheet_item_type_str'}
            ,{'field':'role_id','title':'角色ID','minWidth':120}
            ,{'field':'p_p_str','title':'产品','minWidth':100}
            ,{'field':'p_g_str','title':'游戏','minWidth':100}
            ,{'field':'server_id','title':'区服','minWidth':100}
            ,{'field':'uid','title':'UID','minWidth':100}
            ,{'field':'add_time','title':'创建时间','align':'center','minWidth':195}
            ,{'field':'edit_time','title':'处理时间','align':'center','minWidth':195}
            ,{'title':'状态','minWidth':80,'align':'center','field':'status'}
            ,{'field':'record_user_str','title':'记录人','align':'center','minWidth':100}
            ,{'field':'follow_user_str','title':'跟进人','align':'center','minWidth':100}
            ,{minWidth:220, align:'center', fixed: 'right', title:'操作'
                ,templet:function(d){
                    let str = '';
                    if(d.action){
                        $.each(d.action,function(k,v){
                            str+= action(v,d);
                        })
                    }
                    return str;
                }
            }
        ]];

        initData();

        // 搜索
        form.on('submit(table-search)', function(data){
            page = 1;
            limit = 20;
            $.each(data.field,function(k,v){
                p_data[k] = v;
            })
            p_data['showMyWorkSheet'] = showMyWorkSheet;
            table.reload('table-list', {
                method: 'post'
                ,where: p_data
                ,page: {
                    curr: 1
                }
            });
        });

        // 头部工具监听事件
        table.on('toolbar(table-list)', function(obj){
            switch(obj.event){
                case 'add':
                    layer.open({
                        type: 2
                        ,title: '创建工单'
                        ,content: 'detail.html'
                        ,maxmin: true
                        ,area: [$(window).width()*0.75+'px', $(window).height()*0.9+'px']
                        ,btn: ['保存', '取消']
                        ,yes: function(index, layero){
                            //点击确认触发 iframe 内容中的按钮提交
                            var submit = layero.find('iframe').contents().find("#layui-btn-form-submit");
                            submit.click();
                        }
                    });
                    break;
                case 'export':
                    layer.msg('导出');
                    break;
            };
        });

        // 监听工具条
        table.on('tool(table-list)', function(obj){
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）

            switch(layEvent){
                case 'detail':
                    var open_obj = {
                        type: 2
                        ,title: '编辑工单'
                        ,content: 'detail.html?id='+data.id
                        ,maxmin: true
                        // ,area: [$(window).width()*0.75+'px', $(window).height()*0.9+'px']
                        ,area:['100%','100%']
                    };

                    if(common.inArray('edit',data.action)){
                        open_obj.btn = ['保存', '取消'];
                        open_obj.yes = function(index, layero){
                            //点击确认触发 iframe 内容中的按钮提交
                            var submit = layero.find('iframe').contents().find("#layui-btn-form-submit");
                            submit.click();
                        }
                    }else{
                        open_obj.btn = ['取消'];
                    }
                    layer.open(open_obj);
                    break;
                case 'top':
                    let str = (data.is_top == 0) ? '置顶' : '取消置顶',
                        top_type = (data.is_top == 0) ? 1 : 0;
                    layer.confirm('确定要将工单：'+data.sheet_num+' 进行'+str+'操作吗?', {icon: 3, title:'提示'}, function(index){
                        layer.load(2);
                        common.req({
                            url: topStateUrl,
                            type: 'POST',
                            data: {id: data.id, is_top:top_type},
                            dataType:"json",
                            success: function(json) {
                                if(json.code == 0){
                                    layer.msg(json.msg, {icon: 1,time:1200},function()
                                    {
                                        layer.closeAll();
                                        //$('.table-search-btn').click();//跳转到首页
                                        $('.layui-laypage-btn').click();//刷新当前页
                                    });
                                }else{

                                    layer.msg(json.msg, {icon: 2});
                                    layer.closeAll('loading');

                                }
                            },
                            error: function() {
                                layer.msg('请求失败', {icon: 2});
                                layer.closeAll('loading');
                            }
                        });

                        layer.close(index);
                    });
                    break;

                case 'del':
                    //删除
                    delInfo(data);
                    break;
            };
        });

        form.on('select(sheet_type)',(e)=>{
            getSheetChildInfo(e.value);
            
        })

        //监听我的工单触发按钮
        form.on('switch(myWorkSheet)', function(data){
            //显示赋值
            if(data.elem.checked){
                showMyWorkSheet = 1;
            }else{
                showMyWorkSheet = 0;
            }
            p_data['showMyWorkSheet'] = showMyWorkSheet;
            //调用查询接口
            // $('.table-search-btn').click();//调用父级的查询按钮，跳转到第一页
            table.reload('table-list', {
                method: 'post'
                ,where: p_data
                ,page: {
                    curr: 1
                }
            });
        });

        //监听我的工单触发按钮
        form.on('switch(myWorkSheet)', function(data){
            //显示赋值
            if(data.elem.checked){
                showMyWorkSheet = 1;
            }else{
                showMyWorkSheet = 0;
            }
            p_data['showMyWorkSheet'] = showMyWorkSheet;
            //调用查询接口
            // $('.table-search-btn').click();//调用父级的查询按钮，跳转到第一页
            table.reload('table-list', {
                method: 'post'
                ,where: p_data
                ,page: {
                    curr: 1
                }
            });
        });

        function initData(){

            common.initPowerShow([
                'WorkSheet-list'
            ]);

            var param = common.urlParam;
            p_data = common.merge(p_data,param);

            if(p_data.sheet_type > 0){
                getSheetChildInfo(p_data.sheet_type)
            }

            common.req({
                url: 'work_sheet/listConfig' //获取游戏名称
                ,success:function(json)
                {
                    var admin_list = [];
                    var base_config = json.data;

                    $.each(base_config.platform_list,function(k,v){
                        $('select[name=platform_id]').append('<option value="'+v.id+'">'+v.name+'</option>');
                    });

                    $.each(base_config.sheet_type_arr,function(k,v){
                        $('select[name=sheet_type]').append('<option value="'+v.id+'">'+v.title+'</option>');
                    });

                    $.each(base_config.admin_list,(k,v)=>{
                        admin_list.push({value:v.id,name:v.name})
                    })

                    select_record_user.update({
                        data: admin_list
                    })

                    select_follow_user.update({
                        data: admin_list
                    })

                    var defaultToolbar = [
                        'filter'
                        , 'print'
                        , 'exports'
                    ];

                    if(common.hasPower('WorkSheet-add')){
                        defaultToolbar.unshift({
                            title: '创建工单' //标题
                            ,layEvent: 'add' //事件名，用于 toolbar 事件中使用
                            ,icon: 'layui-icon-add-1' //图标类名
                        });
                    }

                    table.render({
                        elem: '#table-list'
                        ,height: 'full-120'
                        ,url: common.getUrl('work_sheet/list') //数据接口
                        ,headers:common.getHeader()
                        ,page: true //开启分页
                        ,limits:[20,50,100,200,500]
                        ,limit:20
                        ,minWidth:1000
                        ,cols: cols
                        ,toolbar: "#toolbar-test"
                        ,defaultToolbar: defaultToolbar
                        ,method:'POST'
                        ,where:p_data
                        ,done:function(a,b,c){
                            lay_page = b;
                            if(c > 0){

                            }
                            //隐藏加载框
                            common.isLoading(false);
                        }
                    });
                    form.val('edit-form',p_data);
                    form.render();
                }
            });
        }

        //工单类型关联配置信息
        function getSheetChildInfo(e){
            common.req({
                url: get_scheet_type_config_url,
                type: 'POST',
                data: {id:e},
                dataType:"json",
                success: function(json) {
                    layer.closeAll('loading');
                    var status_option ='<option value="">请选择</option>';
                    var sheet_item_type_option ='<option value="">请选择</option>';
                    if(json.code == 0){
                        var json_data = json.data;
                        $.each(json_data.sheet_item_type_list,(k,v)=>{
                            sheet_item_type_option+='<option value="'+v.id+'">'+v.title+'</option>';
                        })
                        $.each(json_data.status_val,(k,v)=>{
                            status_option+='<option value="'+k+'">'+v+'</option>';
                        })
                    }

                    // //更新状态
                    $('select[name=status]').html(status_option)
                    $('select[name=sheet_item_type]').html(sheet_item_type_option)

                    form.render();
                },
                error: function() {
                    layer.msg('请求失败', {icon: 2});
                    layer.closeAll('loading');
                }
            });
        }

    });

    function action(action,data){
        let str = '';
        switch (action) {
            case 'detail':
                str = '<a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="detail">查看详情</a>';
                break;
            case 'top':
                if(data.is_top == 0){
                    str = '<a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="top">置顶</a>';
                }else{
                    str = '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="top">取消置顶</a>';
                }
                break;
            case 'del':
                str = '<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>';
                break;
            default:
                break;
        }

        return str;
    }
</script>

</body>
</html>